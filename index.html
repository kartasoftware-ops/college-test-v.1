<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karta Poster Generator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- html2canvas (Exact Version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>





    <!-- Custom Fonts (Inter) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Noto+Sans:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        .font-mono {
            font-family: 'Courier New', monospace;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Print Styles */
        @media print {
            body {
                visibility: hidden;
                background-color: white;
            }

            #print-area,
            #print-area * {
                visibility: visible;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #print-area {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                z-index: 9999;
            }

            @page {
                size: landscape;
                margin: 0;
            }
        }

        /* Input Range Styling */
        input[type=range] {
            appearance: none;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #22c55e;
            margin-top: -6px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #27272a;
            border-radius: 2px;
        }
    </style>
</head>

<body class="bg-zinc-950 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="border-b border-zinc-800 bg-zinc-950/80 backdrop-blur-md sticky top-0 z-[60] shrink-0">
        <div class="max-w-7xl mx-auto px-4 md:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center font-bold text-black text-xl">
                    K</div>
                <h1 class="font-bold tracking-tight text-zinc-100 text-lg">Karta <span
                        class="text-zinc-500 font-normal">Studio</span></h1>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs font-medium text-zinc-500 hidden md:block" id="header-mode-text">GENERIC
                    MODE</span>
                <button
                    class="px-3 py-1.5 bg-zinc-900 border border-zinc-700 hover:bg-zinc-800 rounded-full text-xs font-medium transition-colors"
                    id="header-theme-pill">
                    Classic Active
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main
        class="max-w-7xl mx-auto px-4 py-8 flex flex-col lg:grid lg:grid-cols-12 gap-8 flex-grow h-[calc(100vh-80px)] w-full">

        <!-- LEFT: CONTROLS -->
        <div
            class="lg:col-span-4 flex flex-col gap-6 lg:h-full lg:overflow-y-auto custom-scrollbar lg:pr-2 lg:pb-20 order-2 lg:order-1">

            <!-- AI Section -->
            <section class="bg-zinc-900/80 border border-zinc-700/50 rounded-2xl p-4 space-y-3 shadow-lg">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-green-500 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> Magic Designer ✨
                    </h2>
                </div>
                <textarea id="ai-prompt"
                    placeholder="Describe your idea (e.g., 'A vibrant grand opening event for a coffee shop on Saturday')"
                    class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-green-500 transition-colors h-20 resize-none placeholder-zinc-600 text-white"></textarea>
                <button id="btn-generate-ai"
                    class="w-full py-2.5 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold text-black transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="wand-2" class="w-3.5 h-3.5"></i> Generate Layout & Content
                </button>
            </section>

            <!-- 1. Poster Type -->
            <section class="space-y-3 bg-zinc-900/30 p-4 rounded-xl border border-zinc-800/50">
                <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="layers" class="w-3.5 h-3.5"></i> Post Type
                </h2>
                <div class="grid grid-cols-3 gap-2" id="type-grid">
                    <!-- Buttons generated by JS -->
                </div>
            </section>

            <!-- 2. Theme & Brand Colors -->
            <section class="space-y-3 bg-zinc-900/30 p-4 rounded-xl border border-zinc-800/50">
                <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="palette" class="w-3.5 h-3.5"></i> Style & Colors
                </h2>
                <!-- Custom Color Pickers -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="space-y-1">
                        <label class="text-[10px] text-zinc-500 font-medium">Primary</label>
                        <div class="flex items-center gap-2 bg-zinc-950 p-1.5 rounded-lg border border-zinc-800">
                            <input type="color" id="color-primary" value="#22c55e"
                                class="bg-transparent w-6 h-6 rounded cursor-pointer border-none p-0">
                            <span class="text-[10px] font-mono text-zinc-400" id="hex-primary">#22c55e</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] text-zinc-500 font-medium">Secondary</label>
                        <div class="flex items-center gap-2 bg-zinc-950 p-1.5 rounded-lg border border-zinc-800">
                            <input type="color" id="color-secondary" value="#14532d"
                                class="bg-transparent w-6 h-6 rounded cursor-pointer border-none p-0">
                            <span class="text-[10px] font-mono text-zinc-400" id="hex-secondary">#14532d</span>
                        </div>
                    </div>
                </div>
                <!-- Gradient Toggle -->
                <div class="flex items-center gap-2 mb-3">
                    <input type="checkbox" id="check-gradient" class="accent-green-500 w-3.5 h-3.5">
                    <label class="text-xs text-zinc-400">Use Gradient Background</label>
                </div>

                <div class="h-px bg-zinc-800/50 my-2"></div>

                <!-- Presets -->
                <label class="text-[10px] text-zinc-500 font-medium mb-1 block">Presets</label>
                <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar" id="theme-list">
                    <!-- Buttons generated by JS -->
                </div>
            </section>

            <!-- 3. Layout -->
            <section class="space-y-3 bg-zinc-900/30 p-4 rounded-xl border border-zinc-800/50">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider">Layout Mode</h2>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="flex bg-zinc-950 p-1 rounded-lg border border-zinc-800 overflow-x-auto custom-scrollbar"
                        id="layout-toggles">
                        <!-- Buttons generated by JS -->
                    </div>
                    <div class="flex bg-zinc-950 p-1 rounded-lg border border-zinc-800" id="align-toggles">
                        <!-- Buttons generated by JS -->
                    </div>
                </div>
            </section>

            <!-- 4. Content Inputs -->
            <section class="space-y-4 border-t border-zinc-800 pt-4 px-2">
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="text-xs text-zinc-500 font-semibold uppercase tracking-tight">Main Heading</label>
                        <button onclick="handleSmartRewrite('headline')"
                            class="text-xs text-green-500 hover:text-green-400 flex items-center gap-1 transition-colors"
                            id="rewrite-headline-btn">
                            <i data-lucide="sparkles" class="w-2.5 h-2.5"></i> AI Rewrite
                        </button>
                    </div>
                    <input id="input-headline"
                        class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none text-white">
                </div>

                <!-- Dynamic Content Fields Container -->
                <div id="dynamic-fields" class="space-y-4"></div>

                <div class="space-y-2" id="cta-container">
                    <label class="text-xs text-zinc-500 font-semibold uppercase tracking-tight">Button Text</label>
                    <input id="input-cta"
                        class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none text-white">
                </div>
            </section>

            <!-- 5. Contact Info -->
            <section class="space-y-3 border-t border-zinc-800 pt-4 px-2">
                <div class="flex items-center justify-between">
                    <h2 class="text-xs font-bold text-zinc-500 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="smartphone" class="w-3.5 h-3.5"></i> Contact Details
                    </h2>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-zinc-600">Show</span>
                        <input type="checkbox" id="check-show-contact" class="accent-green-500 w-4 h-4">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <div
                        class="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 hover:border-zinc-700 transition-colors">
                        <i data-lucide="instagram" class="w-3.5 h-3.5 text-zinc-500 mr-2"></i>
                        <input id="input-instagram" class="bg-transparent w-full text-xs focus:outline-none text-white"
                            placeholder="Instagram handle">
                    </div>
                    <div
                        class="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 hover:border-zinc-700 transition-colors">
                        <i data-lucide="globe" class="w-3.5 h-3.5 text-zinc-500 mr-2"></i>
                        <input id="input-website" class="bg-transparent w-full text-xs focus:outline-none text-white"
                            placeholder="Website URL">
                    </div>
                    <div
                        class="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 hover:border-zinc-700 transition-colors">
                        <i data-lucide="map-pin" class="w-3.5 h-3.5 text-zinc-500 mr-2"></i>
                        <input id="input-location" class="bg-transparent w-full text-xs focus:outline-none text-white"
                            placeholder="Location">
                    </div>
                    <div
                        class="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 hover:border-zinc-700 transition-colors">
                        <i data-lucide="mail" class="w-3.5 h-3.5 text-zinc-500 mr-2"></i>
                        <input id="input-email" class="bg-transparent w-full text-xs focus:outline-none text-white"
                            placeholder="Email Address">
                    </div>
                    <div
                        class="flex items-center bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 hover:border-zinc-700 transition-colors">
                        <i data-lucide="phone" class="w-3.5 h-3.5 text-zinc-500 mr-2"></i>
                        <input id="input-phone" class="bg-transparent w-full text-xs focus:outline-none text-white"
                            placeholder="Phone Number">
                    </div>
                </div>
            </section>

            <!-- Asset Uploads -->
            <section class="grid grid-cols-3 gap-2 pb-8 px-2">
                <div onclick="document.getElementById('file-logo').click()"
                    class="cursor-pointer bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 hover:border-green-500/50 rounded-xl p-3 flex flex-col items-center justify-center gap-2 text-zinc-400 transition-all group h-24 relative">
                    <i data-lucide="upload" class="w-4 h-4 group-hover:text-green-500"></i>
                    <span class="text-[9px] font-medium text-center">Logo</span>
                    <input type="file" id="file-logo" hidden accept="image/*">
                    <button onclick="event.stopPropagation(); updateState('logo', null);"
                        class="absolute top-1 right-1 w-5 h-5 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors"><i
                            data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div onclick="document.getElementById('file-dashboard').click()"
                    class="cursor-pointer bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 hover:border-green-500/50 rounded-xl p-3 flex flex-col items-center justify-center gap-2 text-zinc-400 transition-all group h-24 relative">
                    <i data-lucide="image" class="w-4 h-4 group-hover:text-green-500"></i>
                    <span class="text-[9px] font-medium text-center">Image 1</span>
                    <input type="file" id="file-dashboard" hidden accept="image/*">
                    <button onclick="event.stopPropagation(); updateState('dashboard', null);"
                        class="absolute top-1 right-1 w-5 h-5 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors"><i
                            data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div onclick="document.getElementById('file-person').click()"
                    class="cursor-pointer bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 hover:border-green-500/50 rounded-xl p-3 flex flex-col items-center justify-center gap-2 text-zinc-400 transition-all group h-24 relative">
                    <i data-lucide="user-check" class="w-4 h-4 group-hover:text-green-500"></i>
                    <span class="text-[9px] font-medium text-center">Person</span>
                    <input type="file" id="file-person" hidden accept="image/*">
                    <button onclick="event.stopPropagation(); updateState('personImage', null);"
                        class="absolute top-1 right-1 w-5 h-5 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors"><i
                            data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </section>

        </div>

        <!-- RIGHT: PREVIEW -->
        <div
            class="lg:col-span-8 bg-zinc-900/30 rounded-3xl border border-zinc-800 flex flex-col relative min-h-[500px] lg:h-full overflow-hidden order-1 lg:order-2">

            <!-- Preview Controls -->
            <div class="flex-1 w-full relative flex flex-col items-center justify-center overflow-hidden p-4 md:p-8"
                id="preview-wrapper">

                <!-- Aspect Ratio Controls -->
                <div class="absolute top-4 right-4 md:top-6 md:right-6 flex gap-2 z-50">
                    <button
                        class="ratio-btn text-[10px] px-3 py-1 rounded-full border border-zinc-700 bg-black/50 text-zinc-400 hover:border-zinc-500 transition-all"
                        data-ratio="1:1">1:1</button>
                    <button
                        class="ratio-btn text-[10px] px-3 py-1 rounded-full border border-zinc-700 bg-black/50 text-zinc-400 hover:border-zinc-500 transition-all"
                        data-ratio="16:9">16:9</button>
                    <button
                        class="ratio-btn text-[10px] px-3 py-1 rounded-full border border-zinc-700 bg-black/50 text-zinc-400 hover:border-zinc-500 transition-all"
                        data-ratio="9:16">9:16</button>
                </div>

                <!-- Canvas Mount Point -->
                <div id="preview-container"
                    class="relative z-10 w-full h-full flex items-center justify-center p-2 md:p-4 overflow-hidden transition-all">
                    <!-- The Poster div will be injected here -->
                    <div id="poster-mount"></div>
                </div>

            </div>

            <!-- Footer Toolbar -->
            <div
                class="w-full shrink-0 border-t border-zinc-800/50 bg-zinc-950/30 p-4 flex flex-col md:flex-row items-center justify-between z-50 backdrop-blur-sm gap-4">

                <!-- Zoom -->
                <div class="flex items-center gap-3 bg-zinc-900/50 px-3 py-1.5 rounded-full border border-zinc-800">
                    <button onclick="setZoom('fit')" id="btn-fit"
                        class="p-1.5 rounded-full hover:bg-zinc-800 transition-colors text-green-500 bg-zinc-800"
                        title="Fit to Screen">
                        <i data-lucide="maximize" class="w-3.5 h-3.5"></i>
                    </button>
                    <div class="w-px h-4 bg-zinc-800"></div>
                    <button onclick="adjustZoom(-0.1)" class="text-zinc-400 hover:text-white"><i data-lucide="minus"
                            class="w-3.5 h-3.5"></i></button>
                    <div class="flex items-center gap-2 min-w-[80px]">
                        <input type="range" min="0.2" max="3" step="0.1" value="1" id="zoom-slider" class="w-20 h-1">
                    </div>
                    <button onclick="adjustZoom(0.1)" class="text-zinc-400 hover:text-white"><i data-lucide="plus"
                            class="w-3.5 h-3.5"></i></button>
                    <span id="zoom-value" class="text-[10px] font-mono text-zinc-500 w-8 text-right">100%</span>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="downloadPNG()" id="btn-download"
                        class="px-5 py-2.5 bg-green-600 hover:bg-green-500 text-black font-bold text-xs rounded-full flex items-center gap-2 transition-all shadow-lg shadow-green-900/20 active:scale-95">
                        <i data-lucide="download" class="w-4 h-4"></i> Export High-Res
                    </button>
                </div>




            </div>

        </div>
    </main>

    <!-- LOGIC SCRIPT -->
    <script>
        const apiKey = ""; // Provided by environment

        // --- STATE MANAGEMENT ---
        const state = {
            brandName: 'Karta School',
            logo: null,
            dashboard: null,
            personImage: null,
            posterType: 'admission',
            headline: 'Admissions Open 2026',
            subtext: 'Join us for a journey of excellence and holistic development. Registration open for Class 11.',
            ctaText: 'Apply Now →',
            contactInfo: {
                instagram: '@karta_school',
                website: 'www.kartaschool.edu.np',
                location: 'Kathmandu, Nepal',
                email: 'admissions@karta.edu.np',
                phone: '+977 1 4000000'
            },
            showContact: true,
            featuresList: "Science & Mgmt Streams\nExperienced Faculty\nModern Labs\nScholarship Schemes\nTransport Facility",
            price: 'GPA 4.0', // Used for Result percentage/GPA
            testimonialAuthor: 'Principal', // Used for Quote author
            jobTitle: 'Math Teacher', // Used for Hiring
            eventDate: 'Sat, 12th Aug | 10:00 AM', // Used for Event/Exam
            aspectRatio: '16:9',
            themeMode: 'karta-dark',
            layoutMode: 'center',
            textAlign: 'left',
            zoomMode: 'fit',
            manualScale: 1,
            customColors: {
                primary: '#22c55e',
                secondary: '#14532d',
                useGradient: false
            },
            autoFitScale: 1,
            isGenerating: false
        };

        // --- LOCAL STORAGE ---
        function saveSettings() {
            const data = {
                brandName: state.brandName,
                contactInfo: state.contactInfo,
                logo: state.logo, // Note: storing large base64 strings in localstorage can be risky if too large, but ok for small logos
                customColors: state.customColors
            };
            localStorage.setItem('karta_poster_settings', JSON.stringify(data));
        }

        function loadSettings() {
            const saved = localStorage.getItem('karta_poster_settings');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.brandName) state.brandName = data.brandName;
                    if (data.contactInfo) state.contactInfo = data.contactInfo;
                    if (data.logo) state.logo = data.logo;
                    if (data.customColors) state.customColors = { ...state.customColors, ...data.customColors };
                } catch (e) { console.error("Failed to load settings", e); }
            }
        }

        const typeLayoutMap = {
            admission: 'modern',
            result: 'showcase',
            event: 'hero',
            occasion: 'cover',
            notice: 'magazine',
            exam: 'magazine',
            hiring: 'modern',
            quote: 'minimal'
        };

        // --- CONSTANTS & CONFIGS ---
        const themeConfigs = {
            'ivy-blue': {
                container: 'bg-[#1e3a8a]',
                bgElement: 'bg-[#172554]',
                textMain: 'text-white font-serif font-bold tracking-tight drop-shadow-md',
                textSub: 'text-blue-100 font-sans',
                accent: 'text-[#facc15]', // Yellow/Gold
                border: 'border-white/20',
                cardBg: 'bg-white/10 backdrop-blur-md border border-white/20',
                button: 'bg-[#facc15] text-[#1e3a8a] font-bold hover:bg-[#fbbf24]',
                dashboard: 'rounded-xl shadow-2xl border border-white/20',
                overlay: 'bg-gradient-to-t from-[#172554] via-[#172554]/60 to-transparent',
                footer: 'text-blue-200 border-t border-white/10 bg-[#1e3a8a]/80',
                decoration: `<div class="absolute -top-20 -right-20 w-80 h-80 bg-blue-500/20 rounded-full blur-3xl"></div>`
            },
            'prestige-red': {
                container: 'bg-[#7f1d1d]',
                bgElement: 'bg-[#991b1b]',
                textMain: 'text-white font-serif font-bold tracking-wide',
                textSub: 'text-red-100 font-sans font-light',
                accent: 'text-[#fbbf24]', // Amber
                border: 'border-white/10',
                cardBg: 'bg-black/20 backdrop-blur-sm border border-white/10',
                button: 'bg-[#fbbf24] text-[#7f1d1d] font-bold hover:bg-[#f59e0b]',
                dashboard: 'rounded-lg shadow-2xl border border-white/10',
                overlay: 'bg-gradient-to-t from-black/80 via-black/40 to-transparent',
                footer: 'text-red-200 border-t border-white/10 bg-[#7f1d1d]',
                decoration: `<div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 15px 15px;"></div>`
            },
            'growth-green': {
                container: 'bg-[#064e3b]',
                bgElement: 'bg-[#065f46]',
                textMain: 'text-white font-sans font-bold tracking-tight',
                textSub: 'text-emerald-100',
                accent: 'text-[#34d399]',
                border: 'border-emerald-500/30',
                cardBg: 'bg-emerald-900/40 backdrop-blur-md border border-emerald-500/30',
                button: 'bg-[#34d399] text-[#064e3b] font-bold hover:bg-[#10b981]',
                dashboard: 'rounded-2xl shadow-xl border border-emerald-500/20',
                overlay: 'bg-gradient-to-t from-[#022c22] to-transparent',
                footer: 'text-emerald-200/60 border-t border-emerald-500/20 bg-[#064e3b]',
                decoration: `<div class="absolute bottom-0 left-0 w-full h-1/3 bg-gradient-to-t from-[#022c22] to-transparent opacity-60"></div>`
            },
            'innovation-teal': {
                container: 'bg-[#0f766e]',
                bgElement: 'bg-[#134e4a]',
                textMain: 'text-white font-sans font-bold drop-shadow-md',
                textSub: 'text-teal-100',
                accent: 'text-[#ccfbf1]',
                border: 'border-white/20',
                cardBg: 'bg-white/10 backdrop-blur border border-white/20 shadow-lg',
                button: 'bg-white text-[#0f766e] font-bold hover:bg-teal-50',
                dashboard: 'rounded-xl shadow-lg border border-white/20',
                overlay: 'bg-gradient-to-t from-[#115e59] to-transparent',
                footer: 'text-teal-100/70 border-t border-white/10 bg-[#0f766e]',
                decoration: `<div class="absolute top-0 right-0 w-1/2 h-full bg-white/5 skew-x-12 blur-2xl"></div>`
            },
            'royal-gold': {
                container: 'bg-[#422006]',
                bgElement: 'bg-gradient-to-br from-[#713f12] to-[#422006]',
                textMain: 'text-[#fef08a] font-serif tracking-wide',
                textSub: 'text-[#fde047]',
                accent: 'text-white',
                border: 'border-[#fef08a]/20',
                cardBg: 'bg-black/30 backdrop-blur border border-[#fef08a]/30',
                button: 'bg-gradient-to-r from-[#fef08a] to-[#eab308] text-[#422006] font-bold border-none',
                dashboard: 'rounded-sm border border-[#fef08a]/30 shadow-2xl',
                overlay: 'bg-gradient-to-t from-black/80 to-transparent',
                footer: 'text-[#fef08a]/60 border-t border-[#fef08a]/10 bg-[#422006]',
                decoration: `<div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#fef08a 1px, transparent 1px); background-size: 24px 24px"></div>`
            },
            'clean-white': {
                container: 'bg-[#f8fafc]',
                bgElement: 'bg-white',
                textMain: 'text-black font-sans font-black tracking-tight',
                textSub: 'text-slate-700 font-semibold',
                accent: 'text-[#3b82f6]',
                border: 'border-slate-200',
                cardBg: 'bg-white border border-slate-200 shadow-xl',
                button: 'bg-[#0f172a] text-white font-bold hover:bg-[#334155]',
                dashboard: 'rounded-lg border border-slate-200 shadow-xl',
                overlay: 'bg-gradient-to-t from-white via-white/80 to-transparent',
                footer: 'text-[#64748b] border-t border-slate-200 bg-white',
                decoration: `<div class="absolute top-0 left-0 w-full h-2 bg-[#3b82f6]"></div>`
            }
        };

        // --- DOM ELEMENTS ---
        const previewMount = document.getElementById('poster-mount');

        // --- HELPER FUNCTIONS ---

        function getFeaturesArray() {
            return state.featuresList.split('\n').filter(f => f.trim() !== '');
        }

        // --- RENDERERS ---

        function renderControls() {
            // Update Header
            document.getElementById('header-mode-text').innerText = `${state.posterType.toUpperCase()} MODE`;
            document.getElementById('header-theme-pill').innerText = `${state.themeMode.charAt(0).toUpperCase() + state.themeMode.slice(1)} Active`;

            // Render Types
            const types = [
                { id: 'admission', label: 'Admission', icon: 'graduation-cap' },
                { id: 'result', label: 'Result', icon: 'award' },
                { id: 'event', label: 'Event', icon: 'calendar-heart' },
                { id: 'occasion', label: 'Occasion', icon: 'party-popper' },
                { id: 'notice', label: 'Notice', icon: 'megaphone' },
                { id: 'exam', label: 'Exam', icon: 'clipboard-list' },
                { id: 'hiring', label: 'Hiring', icon: 'briefcase' },
                { id: 'quote', label: 'Quote', icon: 'quote' },
            ];

            const typeGrid = document.getElementById('type-grid');
            typeGrid.innerHTML = types.map(t => `
                <button onclick="updateState('posterType', '${t.id}')" 
                    class="flex flex-col items-center justify-center p-2 rounded-lg border text-xs font-medium transition-all ${state.posterType === t.id ? 'bg-zinc-800 border-green-500 text-white shadow-md' : 'bg-zinc-950 border-zinc-800 text-zinc-400 hover:bg-zinc-800'}">
                    <i data-lucide="${t.icon}" class="w-3.5 h-3.5 mb-1"></i>
                    <span class="scale-90">${t.label}</span>
                </button>
            `).join('');

            // Render Themes
            const themes = [
                { id: 'ivy-blue', label: 'Ivy Blue', color: 'bg-[#1e3a8a]' },
                { id: 'prestige-red', label: 'Crimson', color: 'bg-[#7f1d1d]' },
                { id: 'growth-green', label: 'Growth', color: 'bg-[#064e3b]' },
                { id: 'innovation-teal', label: 'Teal', color: 'bg-[#0f766e]' },
                { id: 'royal-gold', label: 'Gold', color: 'bg-[#422006]' },
                { id: 'clean-white', label: 'Minimal', color: 'bg-white border border-gray-200' },
            ];
            const themeList = document.getElementById('theme-list');
            themeList.innerHTML = themes.map(t => `
                <button onclick="updateState('themeMode', '${t.id}')" 
                    class="flex-shrink-0 w-20 py-2 rounded-lg border text-xs font-medium flex flex-col items-center gap-2 transition-all ${state.themeMode === t.id ? 'ring-2 ring-green-500 border-transparent opacity-100 bg-zinc-800' : 'border-zinc-800 opacity-60 hover:opacity-100 bg-zinc-950'}">
                    <div class="w-6 h-6 rounded-full ${t.color}"></div>
                    ${t.label}
                </button>
            `).join('');

            // Render Layouts
            // Render Layouts
            const layouts = [
                { id: 'center', icon: 'layout', label: 'Center' },
                { id: 'split', icon: 'grid', label: 'Split' },
                { id: 'cover', icon: 'image', label: 'Cover' },
                { id: 'hero', icon: 'user-check', label: 'Hero' },
                { id: 'overlap', icon: 'layers', label: 'Overlap' },
                { id: 'minimal', icon: 'minus', label: 'Minimal' },
                { id: 'showcase', icon: 'box', label: 'Showcase' },
                { id: 'magazine', icon: 'columns', label: 'Magazine' },
                { id: 'modern', icon: 'sidebar', label: 'Modern' },
                { id: 'campus', icon: 'building-2', label: 'Campus' }
            ];
            document.getElementById('layout-toggles').innerHTML = layouts.map(l => `
                <button onclick="updateState('layoutMode', '${l.id}')" class="flex-none w-8 h-8 flex items-center justify-center rounded text-zinc-500 hover:text-white transition-colors ${state.layoutMode === l.id ? 'bg-zinc-800 text-white shadow-sm ring-1 ring-zinc-700' : ''}" title="${l.label}">
                    <i data-lucide="${l.icon}" class="w-4 h-4"></i>
                </button>
            `).join('');

            // Render Alignment
            const aligns = [
                { id: 'left', icon: 'align-left' }, { id: 'center', icon: 'align-center' }, { id: 'right', icon: 'align-right' }
            ];
            document.getElementById('align-toggles').innerHTML = aligns.map(a => `
                <button onclick="updateState('textAlign', '${a.id}')" class="flex-1 flex justify-center py-1.5 rounded text-zinc-500 hover:text-white ${state.textAlign === a.id ? 'bg-zinc-800 text-white shadow-sm' : ''}">
                    <i data-lucide="${a.icon}" class="w-3.5 h-3.5"></i>
                </button>
            `).join('');

            // Color Inputs Update
            document.getElementById('color-primary').value = state.customColors.primary;
            document.getElementById('hex-primary').innerText = state.customColors.primary;
            document.getElementById('color-secondary').value = state.customColors.secondary;
            document.getElementById('hex-secondary').innerText = state.customColors.secondary;
            document.getElementById('check-gradient').checked = state.customColors.useGradient;

            // Update Dynamic Fields
            renderDynamicFields();

            // Refresh Icons
            lucide.createIcons();
        }

        function renderDynamicFields() {
            const container = document.getElementById('dynamic-fields');
            let html = '';

            // Common Inputs
            const input = (label, id, val) => `
                <div>
                    <label class="text-xs text-zinc-500 font-semibold uppercase tracking-tight block mb-1">${label}</label>
                    <input id="${id}" value="${val}" class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none text-white">
                </div>
            `;
            const textArea = (label, id, val, rows = 3) => `
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="text-xs text-zinc-500 font-semibold uppercase tracking-tight">${label}</label>
                        ${id === 'input-subtext' ? `
                        <button onclick="handleSmartRewrite('subtext')" class="text-xs text-green-500 hover:text-green-400 flex items-center gap-1 transition-colors">
                            <i data-lucide="sparkles" class="w-2.5 h-2.5"></i> AI Rewrite
                        </button>` : ''}
                    </div>
                    <textarea id="${id}" rows="${rows}" class="w-full bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm focus:border-green-500 outline-none resize-none text-white">${val}</textarea>
                </div>
            `;

            // Brand Name Input
            html += input('School/College Name', 'input-brand', state.brandName);

            if (state.posterType === 'admission') {
                html += textArea('Highlights (1 per line)', 'input-features', state.featuresList, 5);
            } else if (state.posterType === 'result') {
                html += input('GPA / Percentage', 'input-price', state.price); // Reuse price
                html += input('Student Name', 'input-author', state.testimonialAuthor);
            } else if (state.posterType === 'event' || state.posterType === 'exam') {
                html += input('Date & Time', 'input-event', state.eventDate);
                html += textArea('Details / Syllabus', 'input-subtext', state.subtext);
            } else if (state.posterType === 'hiring') {
                html += input('Position (e.g. "Math Teacher")', 'input-job', state.jobTitle);
                html += textArea('Requirements', 'input-subtext', state.subtext);
            } else if (state.posterType === 'quote') {
                html += input('Author (Optional)', 'input-author', state.testimonialAuthor);
                html += textArea('Quote Text', 'input-subtext', state.subtext);
            } else if (state.posterType === 'occasion') {
                html += textArea('Greeting Message', 'input-subtext', state.subtext);
            } else {
                html += textArea('Description', 'input-subtext', state.subtext);
            }

            container.innerHTML = html;

            // Re-attach listeners
            container.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', (e) => {
                    const id = e.target.id;
                    if (id === 'input-brand') state.brandName = e.target.value;
                    if (id === 'input-features') state.featuresList = e.target.value;
                    if (id === 'input-price') state.price = e.target.value;
                    if (id === 'input-author') state.testimonialAuthor = e.target.value;
                    if (id === 'input-job') state.jobTitle = e.target.value;
                    if (id === 'input-event') state.eventDate = e.target.value;
                    if (id === 'input-subtext') state.subtext = e.target.value;
                    renderPreview();
                });
            });
        }

        // --- CORE RENDER PREVIEW LOGIC ---
        function renderPreview() {
            const theme = themeConfigs[state.themeMode] || themeConfigs['ivy-blue'];
            const { posterType, layoutMode, textAlign, aspectRatio } = state;
            const custom = state.customColors;

            // Generate Custom CSS Variables for Colors
            const rootStyle = `
                --color-primary: ${custom.primary};
                --color-secondary: ${custom.secondary};
            `;

            // Custom Style Overrides (Inline)
            // If custom colors are used, we'll try to apply them via inline styles on specific elements or by injecting a style block
            // For simplicity in this robust renderer, we'll inject a small style block into the preview container

            let customStyleBlock = '';
            if (custom.useGradient) {
                // Override background
                // We use !important to override Tailwind classes easily
                customStyleBlock += `
                    #poster-root .bg-gradient-to-br { background: linear-gradient(135deg, ${custom.primary}, ${custom.secondary} 80%, #000) !important; }
                    #poster-root .text-green-500 { color: ${custom.primary} !important; }
                    #poster-root .text-green-600 { color: ${custom.primary} !important; }
                    #poster-root .bg-green-600 { background-color: ${custom.primary} !important; }
                    #poster-root .bg-green-500 { background-color: ${custom.primary} !important; color: white !important; }
                    #poster-root .border-green-500 { border-color: ${custom.primary} !important; }
                `;
            } else {
                customStyleBlock += `
                    #poster-root .text-green-500 { color: ${custom.primary} !important; }
                    #poster-root .text-green-600 { color: ${custom.primary} !important; }
                    #poster-root .bg-green-600 { background-color: ${custom.primary} !important; }
                    #poster-root .bg-green-500 { background-color: ${custom.primary} !important; color: white !important; }
                    #poster-root .border-green-500 { border-color: ${custom.primary} !important; }
                 `;
            }

            // Dimensions

            // Dimensions
            let widthClass = 'w-[800px] h-[450px]';
            if (aspectRatio === '9:16') widthClass = 'h-[800px] w-[450px]';
            if (aspectRatio === '1:1') widthClass = 'w-[600px] h-[600px]';

            // Helpers
            const isWidescreen = aspectRatio === '16:9';
            const isVertical = aspectRatio === '9:16';
            const titleSize = isWidescreen ? 'text-3xl' : isVertical ? 'text-3xl' : 'text-4xl';
            const subtextSize = isWidescreen ? 'text-xs' : 'text-sm';

            const alignClass = textAlign === 'center' ? 'items-center text-center' : textAlign === 'right' ? 'items-end text-right' : 'items-start text-left';
            const alignFlex = textAlign === 'center' ? 'items-center' : textAlign === 'right' ? 'items-end' : 'items-start';

            // Render Components as Strings
            const renderLogo = () => `
                <div class="flex items-center gap-2 md:gap-3 flex-shrink-0 z-50">
                    ${state.logo ? `<img src="${state.logo}" class="h-8 md:h-10 w-auto object-contain drop-shadow-md">` :
                    `<div class="h-8 w-8 md:h-10 md:w-10 rounded flex items-center justify-center font-bold text-lg md:text-xl shadow-lg flex-shrink-0 ${state.themeMode === 'neon' ? 'bg-green-500 text-black' : state.themeMode === 'swiss' ? 'bg-black text-white' : 'bg-green-600 text-black'}"><span>${state.brandName.charAt(0)}</span></div>`}
                    <div class="font-bold text-base md:text-lg leading-none ${theme.textMain} drop-shadow-sm whitespace-nowrap uppercase">${state.brandName}</div>
                </div>
            `;

            const renderPerson = (customClass = "") => {
                if (!state.personImage) return '';
                const defaultClass = isVertical ? 'w-full h-[60%] right-0' : 'w-[45%] h-[90%] right-0';
                return `<div class="absolute bottom-0 z-20 pointer-events-none transition-all duration-500 ${customClass || defaultClass}"><img src="${state.personImage}" class="w-full h-full object-contain object-bottom drop-shadow-2xl"></div>`;
            };

            const renderDashboard = () => {
                const img = state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover">` :
                    `<div class="w-full h-full flex flex-col items-center justify-center relative overflow-hidden ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'bg-gray-100' : 'bg-zinc-900'}">
                        <div class="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent"></div>
                        <i data-lucide="image" class="w-8 h-8 mb-1 opacity-50 ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-white'}"></i>
                        <span class="text-xs font-medium ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-zinc-400'}">Image / Graphic</span>
                    </div>`;

                return `<div class="relative group transition-all duration-500 w-full ${theme.dashboard} overflow-hidden h-full min-h-[120px] max-h-[250px]">${img}</div>`;
            };

            const renderContent = () => {
                let contentHTML = '';

                // Content Logic based on Poster Type
                if (posterType === 'admission') {
                    const feats = getFeaturesArray().map((f, i) =>
                        `<div class="p-1.5 rounded-lg flex items-center justify-center gap-2 ${theme.cardBg} backdrop-blur-md shadow-sm border-l-2 ${i % 2 === 0 ? 'border-l-green-500' : 'border-l-transparent'} ${isVertical ? 'w-full' : 'w-[48%]'}">
                            <i data-lucide="check-circle" class="w-2.5 h-2.5 shrink-0 ${theme.accent}"></i>
                            <span class="text-[10px] md:text-xs font-semibold whitespace-nowrap leading-none pt-[1px] ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-white'}">${f}</span>
                        </div>`
                    ).join('');

                    contentHTML = `
                        <div class="flex flex-col w-full ${alignFlex}">
                            <div class="${textAlign === 'center' ? 'text-center' : textAlign === 'right' ? 'text-right' : 'text-left'} relative z-10 shrink-0 mb-4">
                                <span class="px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider mb-2 inline-block ${theme.accent} border ${theme.border} bg-black/20 backdrop-blur-sm">Admissions Open</span>
                                <h2 class="${titleSize} leading-none mb-3 ${theme.textMain}">${state.headline}</h2>
                                <p class="${subtextSize} opacity-90 ${theme.textSub} line-clamp-3 leading-normal mb-4">${state.subtext}</p>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full mb-4">${feats}</div>
                            <button class="px-5 py-2.5 rounded-full text-xs font-bold shadow-lg hover:scale-105 active:scale-95 transition-all w-max flex items-center gap-2 ${theme.button}">
                                ${state.ctaText} <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    `;
                } else if (posterType === 'result') {
                    contentHTML = `
                        <div class="flex flex-col w-full ${alignFlex}">
                            <h2 class="${titleSize} leading-none mb-4 ${theme.textMain}">${state.headline}</h2>
                            <div class="p-6 rounded-2xl w-full max-w-sm ${theme.cardBg} flex flex-col items-center text-center shadow-xl">
                                <span class="text-[9px] uppercase tracking-widest font-bold mb-2 ${theme.accent}">Outstanding Performance</span>
                                <div class="text-4xl font-black mb-2 ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-white'}">${state.price}</div>
                                <div class="text-sm font-bold mb-3 ${state.themeMode === 'swiss' ? 'text-black' : 'text-zinc-200'}">${state.testimonialAuthor}</div>
                                <div class="h-px w-full mb-3 ${state.themeMode === 'neon' ? 'bg-green-500/50' : 'bg-zinc-700/30'}"></div>
                                <p class="text-xs opacity-90 ${theme.textSub} italic">"Congratulations on your success!"</p>
                            </div>
                        </div>
                    `;
                } else if (posterType === 'quote') {
                    contentHTML = `
                        <div class="flex flex-col w-full ${alignFlex}">
                            <div class="mb-4 shrink-0 relative">
                                <i data-lucide="quote" class="absolute -top-4 -left-4 w-8 h-8 opacity-20 ${theme.accent}"></i>
                                <h2 class="${isWidescreen ? 'text-lg' : 'text-xl md:text-2xl'} italic leading-tight ${theme.textMain} drop-shadow-lg font-serif">"${state.subtext}"</h2>
                            </div>
                            <div class="flex items-center gap-3 p-3 rounded-xl ${theme.cardBg} shrink-0 mt-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'bg-black text-white' : 'bg-zinc-800 text-white border border-zinc-700'}">${state.testimonialAuthor ? state.testimonialAuthor.charAt(0) : 'Q'}</div>
                                <div>
                                    <div class="font-bold text-xs ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-white'}">${state.testimonialAuthor}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (posterType === 'hiring') {
                    contentHTML = `
                        <div class="flex flex-col w-full ${alignFlex}">
                            <div class="mb-3">
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${theme.accent} border ${theme.border} bg-black/20 backdrop-blur-sm inline-flex items-center gap-1">
                                    <i data-lucide="briefcase" class="w-2.5 h-2.5"></i> We Are Hiring
                                </span>
                            </div>
                            <h2 class="${titleSize} leading-none mb-4 ${theme.textMain}">${state.headline}</h2>
                            <div class="p-4 rounded-lg border-l-4 mb-4 ${state.themeMode === 'neon' ? 'border-green-500' : 'border-blue-500'} ${theme.cardBg}">
                                <h3 class="text-xl font-bold mb-2 ${state.themeMode === 'swiss' || state.themeMode === 'elegant' ? 'text-black' : 'text-white'}">${state.jobTitle}</h3>
                                <p class="${subtextSize} opacity-90 ${theme.textSub} line-clamp-3 leading-relaxed">${state.subtext}</p>
                            </div>
                            <button class="px-5 py-2.5 text-xs transition-all ${theme.button}"><span>Apply Now</span></button>
                        </div>
                    `;
                } else if (posterType === 'event' || posterType === 'exam') {
                    contentHTML = `
                        <div class="flex flex-col w-full ${alignFlex}">
                             <div class="mb-3">
                                <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${theme.accent} border ${theme.border} bg-black/20 backdrop-blur-sm inline-flex items-center gap-1">
                                    <i data-lucide="calendar" class="w-2.5 h-2.5"></i> ${posterType === 'exam' ? 'Exam Schedule' : 'Upcoming Event'}
                                </span>
                            </div>
                            <h2 class="${titleSize} leading-none mb-3 ${theme.textMain}">${state.headline}</h2>
                            <div class="flex items-center gap-3 mb-4">
                                <div class="p-2 rounded-lg border ${theme.border} bg-black/20"><p class="text-xs font-bold ${theme.accent}">${state.eventDate}</p></div>
                            </div>
                            <p class="${subtextSize} opacity-90 ${theme.textSub} line-clamp-3 mb-4 leading-relaxed">${state.subtext}</p>
                            ${posterType === 'event' ? `<button class="px-5 py-2.5 text-xs transition-all ${theme.button}"><span>Join Us</span></button>` : ''}
                        </div>
                    `;
                } else if (posterType === 'occasion') {
                    contentHTML = `
                <div class="flex flex-col w-full ${alignFlex}">
                             <div class="flex items-center justify-center w-12 h-12 rounded-full border border-white/20 bg-white/10 backdrop-blur-md text-yellow-400 mb-4">
                                <i data-lucide="party-popper" class="w-6 h-6 animate-pulse"></i>
                             </div>
                             <h2 class="text-4xl md:text-5xl font-black leading-none mb-4 ${theme.textMain} drop-shadow-2xl tracking-tighter" style="font-family: 'Playfair Display', serif;">${state.headline}</h2>
                             <div class="h-1 w-20 bg-gradient-to-r from-transparent via-yellow-400 to-transparent opacity-80 mb-4"></div>
                             <p class="${subtextSize} opacity-90 ${theme.textSub} max-w-md italic font-serif leading-relaxed">${state.subtext}</p>
                        </div>
                `;
                } else {
                    // Notice (Generic)
                    contentHTML = `
                        <div class="flex flex-col w-full ${alignClass}">
                            ${state.themeMode === 'swiss' ? '<div class="w-8 h-1 bg-black mb-2"></div>' : ''}
                            <i data-lucide="megaphone" class="w-8 h-8 mb-3 ${theme.accent}"></i>
                            <h2 class="${titleSize} leading-none mb-3 transition-all duration-500 ${theme.textMain}">${state.headline}</h2>
                            <p class="${subtextSize} opacity-90 max-w-xs transition-all duration-500 ${theme.textSub} line-clamp-3 leading-relaxed mb-4">${state.subtext}</p>
                            <button class="px-5 py-2.5 text-xs transition-all flex items-center gap-2 ${theme.button}"><span>Read More</span></button>
                        </div>
                    `;
                }
                return contentHTML;
            }

            const renderFooter = () => {
                if (!state.showContact) return '';
                const { website, email, instagram, location } = state.contactInfo;
                return `
                    <div class="${theme.footer} w-full py-2.5 px-6 flex flex-wrap items-center justify-between gap-x-6 gap-y-2 z-40 shrink-0 border-t border-white/10 relative">
                        <div class="flex items-center gap-6">
                            ${website ? `<div class="flex items-center gap-1.5 opacity-90 hover:opacity-100 transition-opacity"><i data-lucide="globe" class="w-3 h-3 ${theme.accent}"></i> <span class="text-[9px] font-bold uppercase tracking-wider leading-none pt-0.5">${website}</span></div>` : ''}
                            ${email ? `<div class="flex items-center gap-1.5 opacity-90 hover:opacity-100 transition-opacity"><i data-lucide="mail" class="w-3 h-3 ${theme.accent}"></i> <span class="text-[9px] font-bold uppercase tracking-wider leading-none pt-0.5">${email}</span></div>` : ''}
                        </div>
                        <div class="flex items-center gap-6">
                             ${instagram ? `<div class="flex items-center gap-1.5 opacity-90 hover:opacity-100 transition-opacity"><i data-lucide="instagram" class="w-3 h-3 ${theme.accent}"></i> <span class="text-[9px] font-bold uppercase tracking-wider leading-none pt-0.5">${instagram}</span></div>` : ''}
                             ${location ? `<div class="flex items-center gap-1.5 opacity-90 hover:opacity-100 transition-opacity"><i data-lucide="map-pin" class="w-3 h-3 ${theme.accent}"></i> <span class="text-[9px] font-bold uppercase tracking-wider leading-none pt-0.5">${location}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // BUILD THE FULL POSTER HTML
            let innerLayout = '';

            // Layout Logic
            if (layoutMode === 'center') {
                innerLayout = aspectRatio === '16:9' ? `
                    <div class="flex-1 flex flex-row gap-6 items-center min-h-0">
                        <div class="flex-1 min-w-0 flex flex-col justify-center">${renderContent()}</div>
                        <div class="flex-1 w-full flex items-center h-full max-h-[250px] relative">
                            ${renderDashboard()}
                            ${state.personImage ? `<div class="absolute bottom-0 -right-4 w-[40%] h-[120%] z-20 flex items-end justify-center pointer-events-none"><img src="${state.personImage}" class="w-full h-full object-contain object-bottom drop-shadow-xl"></div>` : ''}
                        </div>
                    </div>
                ` : `
                    <div class="w-full max-w-lg mx-auto flex-shrink-1 min-h-0 relative">
                        ${renderDashboard()}
                        ${state.personImage ? `<div class="absolute bottom-0 -right-4 w-[35%] h-[120%] z-20 flex items-end justify-center pointer-events-none"><img src="${state.personImage}" class="w-full h-full object-contain object-bottom drop-shadow-xl"></div>` : ''}
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0">${renderContent()}</div>
                `;
            } else if (layoutMode === 'split') {
                const is916 = aspectRatio === '9:16';
                innerLayout = `
                    <div class="flex-1 flex gap-8 items-center min-h-0 px-8 py-4 ${is916 ? 'flex-col-reverse justify-end' : 'flex-row'}">
                        ${is916 ? `
                            <div class="w-full ${theme.cardBg} backdrop-blur-md p-6 rounded-2xl flex-shrink-0">${renderContent()}</div>
                            <div class="flex-1 w-full flex items-center min-h-0 relative">
                                <div class="w-full h-full relative z-0 rounded-2xl overflow-hidden">${renderDashboard()}</div>
                                ${state.personImage ? `<div class="absolute bottom-0 right-0 w-[80%] h-[90%] z-10 flex items-end justify-end pointer-events-none"><img src="${state.personImage}" class="w-full h-full object-contain object-bottom drop-shadow-2xl"></div>` : ''}
                            </div>
                        ` : `
                            <div class="flex-1 flex flex-col justify-center min-w-[45%] py-4">${renderContent()}</div>
                            <div class="flex-1 w-full h-full flex items-center justify-center py-4 pl-4 relative">
                                <div class="w-full h-full relative z-0 rounded-2xl overflow-hidden shadow-2xl">${renderDashboard()}</div>
                                ${state.personImage ? `<div class="absolute bottom-0 -right-8 w-[80%] h-[90%] z-10 flex items-end justify-end pointer-events-none"><img src="${state.personImage}" class="w-full h-full object-contain object-bottom drop-shadow-2xl"></div>` : ''}
                            </div>
                        `}
                    </div>
                `;
            } else if (layoutMode === 'cover') {
                innerLayout = `
                    <div class="absolute inset-0 z-0">
                        ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover">` : `<div class="w-full h-full ${state.themeMode === 'neon' ? 'bg-zinc-900' : 'bg-zinc-800'} flex items-center justify-center"><i data-lucide="image" class="w-24 h-24 opacity-10"></i></div>`}
                        <div class="absolute inset-0 ${theme.overlay} mix-blend-multiply opacity-80"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                    </div>
                    ${renderPerson("w-[40%] h-[80%] right-0 bottom-0 z-10")}
                    <div class="relative z-20 flex-1 flex flex-col ${textAlign === 'center' ? 'items-center' : textAlign === 'right' ? 'items-end' : 'items-start'} justify-end pb-4 px-8 min-h-0">
                        <div class="w-full ${aspectRatio === '16:9' ? 'max-w-2xl pt-16' : 'max-w-md'}">${renderContent()}</div>
                    </div>
                `;
            } else if (layoutMode === 'hero') {
                innerLayout = `
                    <div class="absolute inset-0 z-0 opacity-10"><div class="w-full h-full" style="background-image: radial-gradient(circle 500px at 50% 200px, #3e3e3e, transparent)"></div></div>
                    <div class="absolute top-1/2 left-0 w-full h-full transform -translate-y-1/2 -z-0 opacity-40 scale-110 pointer-events-none ${theme.dashboard}">
                        ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover blur-[2px]">` : ''}
                    </div>
                    ${renderPerson()}
                    <div class="relative z-20 flex-1 flex flex-col ${aspectRatio === '9:16' ? 'justify-start pt-10 px-6' : 'justify-center px-8 max-w-[60%]'} ${textAlign === 'center' ? 'items-center' : textAlign === 'right' ? 'items-end' : 'items-start'}">
                        ${renderContent()}
                    </div>
                `;
            } else if (layoutMode === 'campus') {
                innerLayout = `
                    <div class="flex-1 p-6 md:p-8 flex flex-col">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 h-full mb-4">
                             <!-- Main Card -->
                             <div class="col-span-2 row-span-2 relative rounded-2xl overflow-hidden ${theme.cardBg} border ${theme.border} group">
                                ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">` : `<div class="w-full h-full bg-zinc-800/50 flex items-center justify-center"><i data-lucide="image" class="w-12 h-12 opacity-30"></i></div>`}
                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-6">
                                    <h2 class="${titleSize} leading-tight text-white mb-2 drop-shadow-md">${state.headline}</h2>
                                     <button class="px-4 py-1.5 text-xs bg-white text-black font-bold rounded-lg hover:scale-105 transition-transform">See More</button>
                                </div>
                             </div>
                             <!-- Secondary Image -->
                             <div class="hidden md:block relative rounded-2xl overflow-hidden ${theme.cardBg} border ${theme.border}">
                                ${state.personImage ? `<img src="${state.personImage}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-zinc-800/30 flex items-center justify-center"><i data-lucide="user" class="w-8 h-8 opacity-30"></i></div>`}
                             </div>
                             <!-- Text Card -->
                             <div class="hidden md:flex flex-col justify-center p-4 rounded-2xl ${theme.cardBg} border ${theme.border}">
                                <p class="${subtextSize} opacity-80 ${theme.textSub} line-clamp-4">${state.subtext}</p>
                             </div>
                        </div>
                    </div>
                `;
            } else if (layoutMode === 'minimal') {
                innerLayout = `
                    <div class="flex-1 flex flex-col justify-center p-8 md:p-12">
                        <div class="w-full max-w-4xl mx-auto border-t-2 border-b-2 ${theme.border} py-12 relative flex flex-col items-center text-center">
                            ${renderContent()}
                            <div class="absolute top-0 left-1/2 w-3 h-3 ${theme.accent} bg-current rounded-full -translate-x-1/2 -translate-y-1/2"></div>
                            <div class="absolute bottom-0 left-1/2 w-3 h-3 ${theme.accent} bg-current rounded-full -translate-x-1/2 translate-y-1/2"></div>
                        </div>
                    </div>
                `;
            } else if (layoutMode === 'showcase') {
                innerLayout = `
                    <div class="flex-1 flex items-center justify-center p-8">
                        <div class="w-full max-w-5xl h-[80%] grid grid-cols-1 md:grid-cols-2 gap-0 shadow-2xl rounded-3xl overflow-hidden ${theme.cardBg}">
                            <div class="relative h-48 md:h-full">
                                ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-zinc-800/50 flex items-center justify-center"><i data-lucide="image" class="w-12 h-12 opacity-20"></i></div>`}
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            </div>
                            <div class="p-8 md:p-12 flex flex-col justify-center">
                                ${renderContent()}
                            </div>
                        </div>
                    </div>
                `;
            } else if (layoutMode === 'magazine') {
                innerLayout = `
                    <div class="flex-1 p-6 md:p-12 flex flex-col justify-center">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-8 h-full border-t border-b ${theme.border} py-8">
                            <div class="md:col-span-4 relative md:border-r ${theme.border} md:pr-8 flex flex-col">
                                 <div class="mb-4 text-xs font-mono opacity-50 uppercase tracking-widest">Featured Story</div>
                                 <div class="flex-1 relative overflow-hidden rounded-sm grayscale hover:grayscale-0 transition-all duration-500 min-h-[150px]">
                                    ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-zinc-800/50"></div>`}
                                 </div>
                                 <div class="mt-4 text-[10px] leading-relaxed opacity-60 font-serif">
                                    Official Announcement • Karta Studio<br>Volume 3 • Issue 12
                                 </div>
                            </div>
                            <div class="md:col-span-8 md:pl-4 flex flex-col justify-center relative z-10">
                                ${renderContent()}
                            </div>
                             ${renderPerson("absolute bottom-0 right-0 h-[90%] w-[40%] z-20 object-contain object-bottom pointer-events-none")}
                        </div>
                    </div>
                `;
            } else if (layoutMode === 'modern') {
                innerLayout = `
                    <div class="flex-1 flex md:flex-row flex-col h-full bg-black/20">
                        <div class="md:w-1/3 w-full h-64 md:h-full relative overflow-hidden">
                            <div class="absolute inset-0 z-0">
                                ${state.dashboard ? `<img src="${state.dashboard}" class="w-full h-full object-cover opacity-60">` : `<div class="w-full h-full bg-zinc-800"></div>`}
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent to-black/80"></div>
                            </div>
                            <div class="absolute inset-x-0 bottom-0 top-10 z-10 flex flex-col items-center justify-end">
                                 ${renderPerson("relative h-[90%] w-auto object-contain object-bottom")}
                            </div>
                        </div>
                        <div class="md:w-2/3 w-full h-full p-8 md:p-12 flex flex-col justify-center relative">
                            <div class="absolute top-8 right-8 opacity-10"><i data-lucide="component" class="w-32 h-32 stroke-1"></i></div>
                            <div class="relative z-10 pl-4 border-l-4 ${state.themeMode === 'neon' ? 'border-green-500' : 'border-white/20'}">
                                ${renderContent()}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Construct Final DOM
            const posterHTML = `
                <div id="poster-root" class="relative overflow-hidden transition-all duration-300 ease-out shrink-0 flex flex-col ${widthClass} ${theme.container}" style="transform: scale(${state.zoomMode === 'fit' ? state.autoFitScale : state.manualScale}); transform-origin: center;">
                    <style>${customStyleBlock}</style>
                    <div class="absolute inset-0 ${theme.bgElement}"></div>
                    ${theme.decoration}
                    <div class="relative z-10 w-full h-full flex flex-col">
                        <div class="${layoutMode === 'cover' ? 'absolute top-4 left-6 right-6 z-30' : 'relative p-6 pb-2 w-full'} ${textAlign === 'right' && layoutMode !== 'split' ? 'flex justify-end' : 'flex justify-start'}">
                            ${renderLogo()}
                        </div>
                        <div class="flex-1 flex flex-col ${layoutMode !== 'cover' && layoutMode !== 'hero' ? 'px-6 pb-2' : ''} w-full relative z-20 min-h-0">
                            ${innerLayout}
                        </div>
                        ${renderFooter()}
                    </div>
                </div>
            `;

            previewMount.innerHTML = posterHTML;
            lucide.createIcons();
        }

        // --- ROBUST EXPORT LOGIC ---
        async function downloadPNG() {
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            const originalScroll = window.scrollY;

            // 1. User Feedback
            btn.innerHTML = `<i data-lucide="loader" class="animate-spin w-4 h-4"></i> Processing...`;
            lucide.createIcons();

            // 2. Determine Dimensions
            let targetW = 800, targetH = 450;
            if (state.aspectRatio === '9:16') { targetW = 450; targetH = 800; }
            if (state.aspectRatio === '1:1') { targetW = 600; targetH = 600; }

            // 3. Setup Hidden Container
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = `${targetW}px`;
            container.style.height = `${targetH}px`;
            container.style.zIndex = '-9999';
            container.style.overflow = 'hidden';
            container.style.pointerEvents = 'none';
            document.body.appendChild(container);

            // 4. Clone and Prepare
            const originalNode = document.getElementById('poster-root');
            const clone = originalNode.cloneNode(true);

            // Normalize Clone
            clone.style.transform = 'none';
            clone.style.margin = '0';
            clone.style.boxShadow = 'none';
            clone.style.width = '100%';
            clone.style.height = '100%';
            clone.style.position = 'absolute';
            clone.style.top = '0';
            clone.style.left = '0';

            container.appendChild(clone);

            // 5. High-Fidelity Capture
            try {
                // Scroll Reset
                window.scrollTo(0, 0);

                // Wait for layout
                await document.fonts.ready;
                await new Promise(r => setTimeout(r, 200));

                const canvas = await html2canvas(clone, {
                    scale: 3, // 3x High Resolution
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    imageTimeout: 0,
                    scrollX: 0,
                    scrollY: 0
                });

                // 6. Trigger Download
                const link = document.createElement('a');
                const date = new Date();
                const timestamp = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate()}_${date.getHours()}${date.getMinutes()}`;
                link.download = `Karta_Poster_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();

            } catch (err) {
                console.error("Export Error:", err);
                alert("Export failed. Please check console for details.");
            } finally {
                // 7. Cleanup & Restore
                document.body.removeChild(container);
                window.scrollTo(0, originalScroll);
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }



        // --- APP LOGIC RESTORED ---

        function updateState(key, value) {
            if (key === 'customColors' && typeof value === 'object') {
                // partial update
                state.customColors = { ...state.customColors, ...value };
            } else {
                state[key] = value;
            }

            // Persistence
            saveSettings();

            // Auto-switch Layout based on Type (Only if directly changing type)
            if (key === 'posterType' && typeLayoutMap[value]) {
                state.layoutMode = typeLayoutMap[value];
            }

            renderControls();
            renderPreview();
        }

        function calculateScale() {
            const container = document.getElementById('preview-container');
            const { width: contWidth, height: contHeight } = container.getBoundingClientRect();

            let targetW = 800, targetH = 450;
            if (state.aspectRatio === '9:16') { targetW = 450; targetH = 800; }
            if (state.aspectRatio === '1:1') { targetW = 600; targetH = 600; }

            const padding = 40;
            const availW = contWidth - padding;
            const availH = contHeight - padding;

            if (availW <= 0 || availH <= 0) return; const scaleW = availW / targetW; const scaleH = availH / targetH;
            state.autoFitScale = Math.min(scaleW, scaleH, 1); const scale = state.zoomMode === 'fit' ? state.autoFitScale :
                state.manualScale; document.getElementById('zoom-value').innerText = Math.round(scale * 100) + '%'; const
                    mount = document.getElementById('poster-root'); if (mount) mount.style.transform = `scale(${scale})`;
        } function
            setZoom(mode) { state.zoomMode = mode; calculateScale(); } function adjustZoom(delta) {
                state.zoomMode = 'manual';
                state.manualScale = Math.max(0.1, Math.min(3, state.manualScale + delta)); calculateScale();
            } function handleFile(e,
                key) {
            const file = e.target.files[0]; if (file) {
                const reader = new FileReader(); reader.onload = (evt) => {
                    state[key] = evt.target.result;
                    renderPreview();
                };
                reader.readAsDataURL(file);
            }
        }

        // --- AI LOGIC ---

        async function callGemini(text, sysPrompt, jsonMode = false) {
            if (!apiKey) { alert("API Key missing"); return null; }
            try {
                const res = await
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text }] }],
                                systemInstruction: { parts: [{ text: sysPrompt }] },
                                generationConfig: { responseMimeType: jsonMode ? "application/json" : "text/plain" }
                            })
                        });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        async function generateLayout() {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt) return;

            const btn = document.getElementById('btn-generate-ai');
            btn.innerHTML = `<i data-lucide="loader" class="animate-spin w-3.5 h-3.5"></i> Generating...`;
            lucide.createIcons();

            const sysPrompt = `You are a School Poster Designer. Output valid JSON: { posterType:
    'admission'|'result'|'event'|'notice'|'exam'|'hiring'|'quote'|'occasion', themeMode:
     'ivy-blue'|'prestige-red'|'growth-green'|'innovation-teal'|'royal-gold'|'clean-white', layoutMode:
    'center'|'split'|'cover'|'hero'|'overlap', headline: string, subtext: string, ctaText: string, extraData: {
    featuresList?, price?, testimonialAuthor?, jobTitle?, eventDate? } }.
    Detect the context (e.g. 'Janmashtami' -> 'occasion', 'class 10 results' -> 'result').`;

            const res = await callGemini(prompt, sysPrompt, true);
            if (res) {
                const data = JSON.parse(res);
                state.posterType = data.posterType;
                state.themeMode = data.themeMode;
                state.layoutMode = data.layoutMode;
                state.headline = data.headline;
                state.subtext = data.subtext;
                state.ctaText = data.ctaText;
                if (data.extraData) Object.assign(state, data.extraData);
                renderControls();
            }
            btn.innerHTML = `<i data-lucide="wand-2" class="w-3.5 h-3.5"></i> Generate Layout & Content`;
            lucide.createIcons();
        }

        async function handleSmartRewrite(field) {
            const btn = document.getElementById('rewrite-headline-btn');
            const originalText = btn.innerHTML;
            btn.innerText = "...";

            const context = field === 'headline' ? "Write a punchy headline under 8 words." : "Write an engaging description under 20 words.";
            const current = field === 'headline' ? state.headline : state.subtext;

            const res = await callGemini(current, context);
            if (res) {
                if (field === 'headline') {
                    state.headline = res.trim(); document.getElementById('input-headline').value =
                        state.headline;
                }
                if (field === 'subtext') {
                    state.subtext = res.trim(); document.getElementById('input-subtext').value =
                        state.subtext;
                }
                renderPreview();
            }
            btn.innerHTML = originalText;
            lucide.createIcons();
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            // Inputs
            ['input-headline', 'input-cta'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const key = id === 'input-headline' ? 'headline' : 'ctaText';
                    state[key] = e.target.value;
                    renderPreview();
                });
            });

            // Contact Inputs
            ['instagram', 'website', 'location', 'email', 'phone'].forEach(key => {
                document.getElementById(`input-${key}`).addEventListener('input', (e) => {
                    state.contactInfo[key] = e.target.value;
                    renderPreview();
                });
            });

            document.getElementById('check-show-contact').addEventListener('change', (e) => {
                state.showContact = e.target.checked;
                renderPreview();
            });

            // Files
            document.getElementById('file-logo').addEventListener('change', (e) => handleFile(e, 'logo'));
            document.getElementById('file-dashboard').addEventListener('change', (e) => handleFile(e, 'dashboard'));
            document.getElementById('file-person').addEventListener('change', (e) => handleFile(e, 'personImage'));

            // AI
            document.getElementById('btn-generate-ai').addEventListener('click', generateLayout);

            // Ratio Buttons
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.ratio-btn').forEach(b => {
                        b.classList.remove('bg-white', 'text-black', 'border-white', 'font-bold');
                        b.classList.add('bg-black/50', 'text-zinc-400');
                    });
                    e.target.classList.remove('bg-black/50', 'text-zinc-400');
                    e.target.classList.add('bg-white', 'text-black', 'border-white', 'font-bold');

                    state.aspectRatio = e.target.dataset.ratio;
                    calculateScale();
                    renderPreview();
                });
            });

            // Custom Color Listeners
            document.getElementById('color-primary').addEventListener('input', (e) => {
                updateState('customColors', { primary: e.target.value });
            });
            document.getElementById('color-secondary').addEventListener('input', (e) => {
                updateState('customColors', { secondary: e.target.value });
            });
            document.getElementById('check-gradient').addEventListener('change', (e) => {
                updateState('customColors', { useGradient: e.target.checked });
            });

            // First Load Data
            loadSettings();

            // Initial Setups
            document.querySelector('[data-ratio="16:9"]').click();
            document.getElementById('input-headline').value = state.headline;
            document.getElementById('input-cta').value = state.ctaText;
            document.getElementById('check-show-contact').checked = state.showContact;
            Object.keys(state.contactInfo).forEach(k => {
                document.getElementById(`input-${k}`).value = state.contactInfo[k];
            });

            // Resize listener
            window.addEventListener('resize', calculateScale);

            // First Render
            renderControls();
            renderPreview();
        });

    </script>
</body>

</html>

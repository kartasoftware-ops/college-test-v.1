<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Notice Platform</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e40af">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3413/3413535.png">

    <style>
        :root {
            --theme-color: #1e40af;
            /* Default fallback */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
        }

        /* Dynamic Theme Classes */
        .theme-bg {
            background-color: var(--theme-color) !important;
        }

        .theme-text {
            color: var(--theme-color) !important;
        }

        .theme-border {
            border-color: var(--theme-color) !important;
        }

        .theme-ring:focus {
            --tw-ring-color: var(--theme-color) !important;
        }

        /* Interactive elements */
        .notice-card {
            transition: all 0.3s ease;
        }

        .notice-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loader */
        .loader {
            border-top-color: var(--theme-color);
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        /* Mobile Tap Highlights */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Install Button Animation */
        #install-btn {
            animation: pulse-soft 2s infinite;
        }

        @keyframes pulse-soft {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col">

    <!-- Navigation Bar -->
    <nav class="theme-bg text-white shadow-lg sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="goHome()">
                <!-- Logo Placeholder in Nav -->
                <img id="nav-logo" src="" alt="Logo" class="h-10 w-10 rounded-full bg-white object-contain p-1 hidden">
                <i id="nav-icon" class="fa-solid fa-graduation-cap text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide truncate max-w-[140px] sm:max-w-none">College Notices</h1>
            </div>

            <div class="flex items-center space-x-3">
                <!-- PWA Install Button -->
                <button id="install-btn"
                    class="hidden bg-white text-blue-900 px-3 py-1.5 rounded-full text-xs font-bold shadow-md hover:bg-gray-100 transition flex items-center">
                    <i class="fa-solid fa-download mr-2"></i> Install App
                </button>

                <div id="nav-actions">
                    <!-- Dynamic Content injected here -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow container mx-auto px-4 py-8 relative">

        <!-- Suggestion Modal (Student) -->
        <div id="suggestion-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
                <button onclick="document.getElementById('suggestion-modal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
                <div class="text-center mb-4">
                    <div
                        class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fa-regular fa-paper-plane text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Suggestion Box</h3>
                    <p class="text-xs text-gray-500 mt-1">Anonymous & Confidential</p>
                </div>
                <form onsubmit="submitSuggestion(event)">
                    <textarea id="suggestion-text" rows="4" required
                        placeholder="Write your suggestion, complaint or feedback here..."
                        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 resize-none"></textarea>
                    <button type="submit"
                        class="w-full theme-bg text-white font-bold py-3 rounded-xl shadow hover:opacity-90 transition">
                        Send Anonymously
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Inbox Modal -->
        <div id="admin-inbox-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-lg p-0 shadow-2xl relative flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><i
                            class="fa-solid fa-inbox text-blue-500"></i> Suggestion Inbox</h3>
                    <button onclick="document.getElementById('admin-inbox-modal').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                <div id="inbox-list" class="flex-grow overflow-y-auto p-4 space-y-3">
                    <!-- Items -->
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-view"
            class="fixed inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center z-50 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="theme-text font-bold text-lg">Loading...</p>
        </div>

        <!-- 1. Landing / Auth View -->
        <div id="auth-view" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden mt-10 hidden">
            <div class="md:flex">
                <!-- Left Side: Hero -->
                <div
                    class="hidden md:block md:w-1/2 theme-bg p-10 text-white flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-black opacity-10"></div>
                    <div class="relative z-10">
                        <i class="fa-solid fa-school text-6xl mb-6 opacity-80"></i>
                        <h2 class="text-3xl font-bold mb-4">Digital Notice Board</h2>
                        <p class="opacity-90 leading-relaxed">Streamline your school's communication. Post updates, exam
                            schedules, and results in real-time with a professional, branded interface.</p>
                    </div>
                </div>

                <!-- Right Side: Forms -->
                <div class="w-full md:w-1/2 p-8 md:p-12">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
                        <p class="text-gray-500 text-sm mt-1">Please login or register your institution</p>
                    </div>

                    <!-- Error Message Box -->
                    <div id="auth-error"
                        class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded mb-6 text-sm"
                        role="alert">
                        <span class="block sm:inline" id="auth-error-msg"></span>
                    </div>

                    <!-- Toggle Login/Signup -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="tab-login"
                            class="w-1/2 py-3 theme-text border-b-2 theme-border font-bold focus:outline-none transition-all"
                            onclick="toggleAuthMode('login')">Login</button>
                        <button id="tab-signup"
                            class="w-1/2 py-3 text-gray-400 font-medium hover:text-gray-600 focus:outline-none transition-all"
                            onclick="toggleAuthMode('signup')">Register</button>
                    </div>

                    <!-- Login Form -->
                    <form id="login-form" class="space-y-5" onsubmit="handleLogin(event)">
                        <div>
                            <label class="block text-gray-700 text-xs font-bold uppercase mb-2">Email Address</label>
                            <input type="email" id="login-email" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold uppercase mb-2">Password</label>
                            <input type="password" id="login-pass" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <button type="submit"
                            class="w-full theme-bg text-white font-bold py-3 rounded-lg hover:opacity-90 transition duration-200 shadow-lg transform hover:-translate-y-0.5">
                            Sign In
                        </button>
                    </form>

                    <!-- Signup Form -->
                    <form id="signup-form" class="space-y-4 hidden" onsubmit="handleSignup(event)">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-gray-700 text-xs font-bold uppercase mb-1">School Name</label>
                                <input type="text" id="signup-name" required placeholder="St. Xavier's High School"
                                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>

                            <!-- Theme Color Picker -->
                            <div>
                                <label class="block text-gray-700 text-xs font-bold uppercase mb-1">Brand Color</label>
                                <div class="flex items-center space-x-2 border rounded-lg p-1 bg-white">
                                    <input type="color" id="signup-color" value="#1e40af"
                                        class="h-8 w-10 cursor-pointer border-none bg-transparent"
                                        onchange="previewTheme(this.value)">
                                    <span class="text-xs text-gray-500">Pick Theme</span>
                                </div>
                            </div>

                            <!-- Logo Upload -->
                            <div>
                                <label class="block text-gray-700 text-xs font-bold uppercase mb-1">Logo (Image)</label>
                                <input type="file" id="signup-logo" accept="image/*"
                                    class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <p class="text-[10px] text-gray-400 mt-1">Max size 100KB</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-xs font-bold uppercase mb-1">Email</label>
                            <input type="email" id="signup-email" required
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-xs font-bold uppercase mb-1">Password</label>
                            <input type="password" id="signup-pass" required minlength="6"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <button type="submit"
                            class="w-full theme-bg text-white font-bold py-3 rounded-lg hover:opacity-90 transition shadow-md">
                            Create Account
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. Admin Dashboard View -->
        <div id="admin-view" class="hidden">
            <!-- Admin Header -->
            <div
                class="bg-white rounded-xl shadow-sm p-6 mb-8 border-l-8 theme-border flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <img id="admin-logo-display" src="" alt=""
                        class="h-16 w-16 object-contain mr-4 rounded-lg bg-gray-50 border p-1 hidden">
                    <div>
                        <div class="flex items-center space-x-3">
                            <h2 class="text-3xl font-bold text-gray-800" id="admin-school-name">School Name</h2>
                            <button id="admin-inbox-btn"
                                class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition relative"
                                title="Suggestion Inbox">
                                <i class="fa-solid fa-inbox text-xl"></i>
                            </button>
                        </div>
                        <span
                            class="inline-block bg-gray-100 rounded-full px-3 py-1 text-xs font-semibold text-gray-600 mt-1">Administrator
                            Dashboard</span>
                    </div>
                </div>
                <div class="flex flex-col items-end bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Public Notice Board Link</p>
                    <div class="flex items-center">
                        <input type="text" id="public-link-input" readonly
                            class="bg-white border border-gray-200 text-gray-600 text-sm rounded-l-md px-3 py-2 w-64 outline-none focus:border-blue-300">
                        <button onclick="copyLink()"
                            class="theme-bg text-white px-4 py-2 rounded-r-md hover:opacity-90 text-sm font-medium transition">
                            Copy
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Add Notice Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 sticky top-24 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-6 pb-2 border-b flex items-center">
                            <i class="fa-solid fa-pen-nib theme-text mr-3"></i>Post Notice
                        </h3>
                        <form onsubmit="postNotice(event)" class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Type</label>
                                <div class="relative">
                                    <select id="notice-category"
                                        class="block appearance-none w-full bg-gray-50 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                                        <option value="General">General Announcement</option>
                                        <option value="Exam Schedule">Exam Schedule</option>
                                        <option value="Exam Result">Exam Results</option>
                                        <option value="Holiday">Holiday / Closure</option>
                                        <option value="Event">Event / Program</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                                <input type="text" id="notice-title" required placeholder="Subject of the notice"
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded focus:outline-none focus:bg-white focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Content</label>
                                <textarea id="notice-content" rows="6" required
                                    placeholder="Write the detailed notice here..."
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded focus:outline-none focus:bg-white focus:border-blue-500 transition resize-none"></textarea>
                            </div>

                            <!-- New Media Fields -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Attach
                                        Image</label>
                                    <input type="file" id="notice-image" accept="image/*"
                                        class="w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p class="text-[10px] text-gray-400 mt-1">Max size 500KB</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Important
                                        Link</label>
                                    <input type="url" id="notice-link" placeholder="https://..."
                                        class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:outline-none focus:bg-white focus:border-blue-500 transition">
                                </div>
                            </div>
                            <button type="submit"
                                class="w-full theme-bg text-white font-bold py-3 rounded shadow hover:shadow-md transition transform hover:-translate-y-0.5">
                                Publish Now
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Notices List -->
                <div class="lg:col-span-2">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800"><i
                                class="fa-solid fa-layer-group theme-text mr-2"></i>Recent Notices</h3>
                        <span id="notice-count"
                            class="theme-bg text-white text-xs font-bold px-3 py-1 rounded-full">0</span>
                    </div>

                    <div id="admin-notices-list" class="space-y-5">
                        <div
                            class="text-center text-gray-400 py-12 bg-white rounded-xl border border-dashed border-gray-300">
                            <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-50"></i>
                            <p>No notices posted yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Public Notice Board View -->
        <div id="public-view" class="hidden">
            <!-- Public Header -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-10 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 theme-bg"></div>

                <div class="relative z-10 flex flex-col items-center">
                    <img id="public-logo-display" src="" alt="School Logo"
                        class="h-24 w-24 object-contain mb-4 rounded-xl bg-white shadow-sm border p-1 hidden">

                    <!-- Fallback Icon if no logo -->
                    <div id="public-logo-fallback"
                        class="w-20 h-20 theme-bg bg-opacity-10 theme-text rounded-full flex items-center justify-center mb-4 text-3xl hidden">
                        <i class="fa-solid fa-school"></i>
                    </div>

                    <h2 class="text-4xl font-extrabold text-gray-900 mb-2" id="public-school-name">Loading...</h2>
                    <p class="text-gray-500 font-medium tracking-wide uppercase text-sm">Official Digital Notice Board
                    </p>
                </div>
            </div>

            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-8 px-2">
                    <h3 class="text-2xl font-bold text-gray-700">Latest Updates</h3>
                    <div class="hidden sm:flex space-x-2">
                        <div class="flex items-center text-xs text-gray-500 bg-white px-2 py-1 rounded border">
                            <div class="w-2 h-2 rounded-full bg-red-500 mr-1"></div> Urgent
                        </div>
                        <div class="flex items-center text-xs text-gray-500 bg-white px-2 py-1 rounded border">
                            <div class="w-2 h-2 rounded-full bg-green-500 mr-1"></div> Result
                        </div>
                    </div>
                </div>

                <div id="internal-install-banner"
                    class="hidden bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6 flex items-center justify-between shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                            <i class="fa-solid fa-mobile-screen-button"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm">Install App</p>
                            <p class="text-xs text-gray-500">Get faster access & notifications</p>
                        </div>
                    </div>
                    <button id="internal-pwa-install-btn"
                        class="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded-full shadow hover:bg-blue-700 transition">
                        Install
                    </button>
                </div>

                <h2 id="public-college-name" class="text-2xl font-bold text-gray-800 mb-6 text-center hidden sm:block">
                    No College Selected</h2>

                <!-- Search Bar -->
                <div class="mb-6 relative max-w-2xl mx-auto">
                    <input type="text" id="public-search" placeholder="Search notices by title, category, or content..."
                        class="w-full pl-12 pr-4 py-4 bg-white border border-gray-100 rounded-xl shadow-lg shadow-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-100 text-gray-700 transition"
                        oninput="filterNotices(this.value)">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-gray-400 text-lg"></i>
                    </div>
                </div>

                <div id="public-notices-list" class="grid gap-6">
                    <!-- Public notices injected here -->
                    <div class="text-center py-12">
                        <div
                            class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mx-auto mb-3">
                        </div>
                        <p class="text-gray-400">Fetching notices...</p>
                    </div>
                </div>
            </div>
        </div>

    </main>





    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, query, orderByChild, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeYEMW_kZShuHq4xgJbM0U7x0ls44IH58",
            authDomain: "gurukul-d1802.firebaseapp.com",
            databaseURL: "https://gurukul-d1802-default-rtdb.firebaseio.com",
            projectId: "gurukul-d1802",
            storageBucket: "gurukul-d1802.firebasestorage.app",
            messagingSenderId: "120852475096",
            appId: "1:120852475096:web:4a8227ec6129fded39bbad",
            measurementId: "G-F9KS828644"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- State ---
        let currentUser = null;
        let currentTheme = "#1e40af"; // Default

        // --- Theme Logic ---
        window.previewTheme = (color) => {
            updateAppTheme(color);
        };

        function updateAppTheme(color) {
            if (!color) return;
            currentTheme = color;
            document.documentElement.style.setProperty('--theme-color', color);

            // For older browsers or specific tailwind overrides
            const dynamicStyles = document.querySelectorAll('.theme-bg');
            dynamicStyles.forEach(el => el.style.backgroundColor = color);
        }

        // --- Navigation Logic ---
        function handleRouting() {
            const urlParams = new URLSearchParams(window.location.search);
            const schoolIdParam = urlParams.get('school');

            hideAllViews();

            if (schoolIdParam) {
                // Public View
                loadPublicSchoolData(schoolIdParam);
                document.getElementById('public-view').classList.remove('hidden');
                updateNav(false);
            } else {
                // Admin View
                if (currentUser) {
                    showAdminDashboard();
                } else {
                    document.getElementById('auth-view').classList.remove('hidden');
                    // Reset theme to default for auth page
                    updateAppTheme('#1e40af');
                }
                updateNav(true);
            }
        }

        function hideAllViews() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('public-view').classList.add('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('internal-install-banner').classList.add('hidden'); // Hide internal banner on view change
        }

        function updateNav(isAdminSide) {
            const navActions = document.getElementById('nav-actions');
            navActions.innerHTML = '';

            const navLogo = document.getElementById('nav-logo');
            const navIcon = document.getElementById('nav-icon');
            const navText = document.querySelector('nav h1'); // Reset nav text for admin/auth

            if (isAdminSide && currentUser) {
                // Admin Side Logged In
                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'text-sm bg-white bg-opacity-20 text-white border border-white border-opacity-40 px-4 py-2 rounded-lg font-bold hover:bg-opacity-30 transition';
                logoutBtn.innerHTML = '<i class="fa-solid fa-right-from-bracket mr-2"></i>Logout';
                logoutBtn.onclick = handleLogout;
                navActions.appendChild(logoutBtn);

                navLogo.classList.add('hidden');
                navIcon.classList.remove('hidden');
                navText.innerText = 'College Notices'; // Reset to default
            } else if (!isAdminSide) {
                // Public View - Minimal
                // Add Suggestion Box Button
                const suggestionBtn = document.createElement('button');
                suggestionBtn.className = 'text-sm bg-white bg-opacity-90 text-blue-900 border border-blue-100 px-3 py-1.5 rounded-lg font-bold hover:bg-opacity-100 transition shadow-sm flex items-center';
                suggestionBtn.innerHTML = '<i class="fa-regular fa-paper-plane mr-2"></i> Suggestion Box';
                suggestionBtn.onclick = () => document.getElementById('suggestion-modal').classList.remove('hidden');
                navActions.appendChild(suggestionBtn);
            } else {
                // Auth View (Admin Login page)
                const loginLink = document.createElement('a');
                loginLink.href = window.location.pathname;
                loginLink.className = 'text-sm text-white text-opacity-80 hover:text-opacity-100 transition underline decoration-dotted';
                loginLink.innerText = 'Admin Login';
                navActions.appendChild(loginLink);

                navLogo.classList.add('hidden');
                navIcon.classList.remove('hidden');
                navText.innerText = 'College Notices'; // Reset to default
            }
        }

        // --- Authentication ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            setLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showError(error.message);
                setLoading(false);
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();

            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            const color = document.getElementById('signup-color').value;
            const fileInput = document.getElementById('signup-logo');
            const file = fileInput.files[0];

            if (file && file.size > 102400) { // 100KB Limit
                showError("Logo image is too large. Please use an image under 100KB.");
                return;
            }

            setLoading(true);

            // Helper to process registration after image read
            const registerUser = async (logoBase64) => {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;

                    await set(ref(db, 'schools/' + user.uid + '/profile'), {
                        name: name,
                        email: email,
                        themeColor: color,
                        logoUrl: logoBase64 || "",
                        joinedAt: new Date().toISOString()
                    });
                    // Routing handles the rest
                } catch (error) {
                    showError(error.message);
                    setLoading(false);
                }
            };

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    registerUser(reader.result);
                };
                reader.readAsDataURL(file);
            } else {
                registerUser("");
            }
        };

        window.handleLogout = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // --- Admin Logic ---
        function showAdminDashboard() {
            hideAllViews();
            document.getElementById('admin-view').classList.remove('hidden');
            setLoading(true);

            const link = `${window.location.origin}${window.location.pathname}?school=${currentUser.uid}`;
            document.getElementById('public-link-input').value = link;

            // Wire up Inbox Button
            document.getElementById('admin-inbox-btn').onclick = () => {
                document.getElementById('admin-inbox-modal').classList.remove('hidden');
                loadSuggestions();
            };

            // Fetch Profile
            onValue(ref(db, 'schools/' + currentUser.uid + '/profile'), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('admin-school-name').innerText = data.name;

                    // Apply Theme
                    if (data.themeColor) updateAppTheme(data.themeColor);

                    // Show Logo
                    const logoImg = document.getElementById('admin-logo-display');
                    if (data.logoUrl) {
                        logoImg.src = data.logoUrl;
                        logoImg.classList.remove('hidden');
                    } else {
                        logoImg.classList.add('hidden');
                    }
                }
                setLoading(false);
            });

            // Fetch Notices
            onValue(ref(db, 'schools/' + currentUser.uid + '/notices'), (snapshot) => {
                const list = document.getElementById('admin-notices-list');
                list.innerHTML = '';
                let count = 0;

                const notices = [];
                snapshot.forEach(c => notices.push({ id: c.key, ...c.val() }));
                notices.reverse();

                if (notices.length === 0) {
                    list.innerHTML = `
                        <div class="text-center text-gray-400 py-12 bg-white rounded-xl border-2 border-dashed border-gray-200">
                            <i class="fa-regular fa-clipboard text-4xl mb-3 opacity-30"></i>
                            <p>No notices posted yet.</p>
                        </div>`;
                }

                notices.forEach((notice) => {
                    count++;
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-sm p-5 border border-gray-100 hover:shadow-md transition relative group';
                    card.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <span class="text-[10px] font-bold theme-text bg-gray-100 px-2 py-1 rounded uppercase tracking-wide border border-gray-200">${notice.category}</span>
                    <h4 class="text-lg font-bold text-gray-800 mt-2">${notice.title}</h4>
                    <p class="text-xs text-gray-400 mt-1"><i class="fa-regular fa-clock mr-1"></i>${new Date(notice.timestamp).toLocaleString()}</p>
                </div>
                <button onclick="deleteNotice('${notice.id}')" class="text-gray-300 hover:text-red-500 transition p-2 opacity-0 group-hover:opacity-100">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                </button>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100">
                <p class="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed">${notice.content}</p>
            </div>
            `;
                    list.appendChild(card);
                });
                document.getElementById('notice-count').innerText = count;

                // --- Analytics Calculation ---
                let totalViews = 0;
                let totalLikes = 0;
                let totalComments = 0;

                notices.forEach(n => {
                    totalViews += (n.views || 0);
                    totalLikes += (n.likes || 0);
                    if (n.comments) totalComments += Object.keys(n.comments).length;
                });

                const analyticsHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                            <div class="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mb-2">
                                <i class="fa-regular fa-eye"></i>
                            </div>
                            <p class="text-2xl font-bold text-gray-800">${totalViews}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total Views</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                            <div class="bg-orange-50 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center mb-2">
                                <i class="fa-regular fa-file-lines"></i>
                            </div>
                            <p class="text-2xl font-bold text-gray-800">${count}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Notices</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                            <div class="bg-green-50 text-green-600 w-8 h-8 rounded-full flex items-center justify-center mb-2">
                                <i class="fa-regular fa-thumbs-up"></i>
                            </div>
                            <p class="text-2xl font-bold text-gray-800">${totalLikes}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Total Likes</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center">
                            <div class="bg-purple-50 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mb-2">
                                <i class="fa-regular fa-comments"></i>
                            </div>
                            <p class="text-2xl font-bold text-gray-800">${totalComments}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Comments</p>
                        </div>
                    </div>
                `;

                // Insert Analytics before list
                const dashboardHeader = list.previousElementSibling || list.parentNode.querySelector('h3'); // fallback
                // Check if already exists to avoid dupes on re-render (naive check)
                const existingAnalytics = document.getElementById('admin-analytics-dashboard');
                if (existingAnalytics) existingAnalytics.remove();

                const analyticsContainer = document.createElement('div');
                analyticsContainer.id = 'admin-analytics-dashboard';
                analyticsContainer.innerHTML = analyticsHTML;

                if (list.parentNode) {
                    list.parentNode.insertBefore(analyticsContainer, list);
                }
            });
        }

        window.postNotice = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const btn = e.target.querySelector('button');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Posting...';

            const title = document.getElementById('notice-title').value;
            const category = document.getElementById('notice-category').value;
            const content = document.getElementById('notice-content').value;
            const linkUrl = document.getElementById('notice-link').value;
            const fileInput = document.getElementById('notice-image');
            const file = fileInput.files[0];

            if (file && file.size > 512000) { // 500KB Limit
                alert("Image too large. Max 500KB.");
                btn.disabled = false;
                btn.innerHTML = originalContent;
                return;
            }

            const saveNotice = async (imgBase64) => {
                try {
                    await push(ref(db, 'schools/' + currentUser.uid + '/notices'), {
                        title,
                        category,
                        content,
                        linkUrl: linkUrl || "",
                        imageUrl: imgBase64 || "",
                        likes: 0,
                        dislikes: 0,
                        views: 0, // Initialize views
                        timestamp: new Date().toISOString()
                    });
                    e.target.reset();
                    // alert('Posted!'); 
                } catch (err) {
                    alert(err.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            };

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => saveNotice(reader.result);
                reader.readAsDataURL(file);
            } else {
                saveNotice("");
            }
        };

        window.deleteNotice = async (id) => {
            if (confirm('Delete this notice permanently?')) {
                await remove(ref(db, 'schools/' + currentUser.uid + '/notices/' + id));
            }
        };

        // --- Public Public Data Fetch ---
        let lastNoticeDate = null;

        function loadPublicSchoolData(schoolId) {
            setLoading(true);
            const banner = document.getElementById('internal-install-banner'); // Changed to internal banner
            const mainInstallBtn = document.getElementById('internal-pwa-install-btn'); // Changed to internal button

            // Wire up main install button if supported
            if (window.deferredPrompt) {
                banner.classList.remove('hidden');
                mainInstallBtn.addEventListener('click', async () => {
                    window.deferredPrompt.prompt();
                    const { outcome } = await window.deferredPrompt.userChoice;
                    if (outcome === 'accepted') banner.classList.add('hidden');
                    window.deferredPrompt = null;
                });
            }

            // Notification Permission
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            const schoolRef = ref(db, 'schools/' + schoolId);
            onValue(schoolRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    document.getElementById('public-view').innerHTML = `<div class="text-center mt-20 text-red-500 font-bold">School Not Found</div>`;
                    setLoading(false);
                    return;
                }

                // Header Branding Override
                const navLogo = document.getElementById('nav-logo');
                const navText = document.querySelector('nav h1');
                const navIcon = document.getElementById('nav-icon');

                if (data.profile) {
                    // Update Text
                    navText.innerText = data.profile.name || "Notice Board";
                    document.getElementById('public-school-name').innerText = data.profile.name || "Notices";
                    updateAppTheme(data.profile.themeColor);

                    // Re-enable footer if we want stats? No, user said remove "everything"
                    // Branding Logo
                    if (data.profile.logoUrl) {
                        navLogo.src = data.profile.logoUrl;
                        navLogo.classList.remove('hidden');
                        navIcon.classList.add('hidden');
                    } else {
                        navLogo.classList.add('hidden');
                        navIcon.classList.remove('hidden');
                    }

                    // --- DYNAMIC MANIFEST UPDATE ---
                    updateDynamicManifest(data.profile);
                }

                const list = document.getElementById('public-notices-list');
                list.innerHTML = '';

                if (!data.notices) {
                    list.innerHTML = `<div class="text-center p-8 text-gray-400">No notices posted yet.</div>`;
                    setLoading(false);
                    return;
                }

                // Store in global scope for search filtering
                window.publicNotices = Object.entries(data.notices).map(([key, val]) => ({ id: key, ...val }));
                const notices = window.publicNotices;
                // Sort by timestamp desc
                notices.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Notification Logic for New Notices
                if (lastNoticeDate && notices.length > 0) {
                    const newest = notices[0];
                    if (new Date(newest.timestamp) > lastNoticeDate) {
                        // Logic to show notification
                        if (Notification.permission === "granted") {
                            new Notification(data.profile.name, {
                                body: "New Notice: " + newest.title,
                                icon: data.profile.logoUrl || './icon-192.png'
                            });
                        }
                    }
                }
                lastNoticeDate = notices.length > 0 ? new Date(notices[0].timestamp) : new Date();

                renderNotices(window.publicNotices);
                setLoading(false);
            });
        }

        // --- Search Logic ---
        window.filterNotices = (query) => {
            if (!window.publicNotices) return;
            const term = query.toLowerCase();
            const filtered = window.publicNotices.filter(n =>
                (n.title && n.title.toLowerCase().includes(term)) ||
                (n.content && n.content.toLowerCase().includes(term)) ||
                (n.category && n.category.toLowerCase().includes(term))
            );
            renderNotices(filtered);
        };

        window.renderNotices = (notices) => {
            const list = document.getElementById('public-notices-list');
            list.innerHTML = '';

            if (notices.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-gray-400">No matching notices found.</div>`;
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const schoolId = urlParams.get('school');

            notices.forEach(notice => {
                // Category Logic
                let accentColor = "var(--theme-color)";
                let icon = "fa-bullhorn";
                const category = notice.category || "General";

                if (category.includes('Exam')) { accentColor = "#ef4444"; icon = "fa-clock"; }
                else if (category.includes('Result')) { accentColor = "#22c55e"; icon = "fa-square-check"; }
                else if (category.includes('Holiday')) { accentColor = "#eab308"; icon = "fa-umbrella-beach"; }

                // Process Comments
                const commentsCount = notice.comments ? Object.keys(notice.comments).length : 0;

                // Media Logic
                let mediaHTML = "";
                if (notice.imageUrl) {
                    mediaHTML += `<div class="mb-4 rounded-lg overflow-hidden border border-gray-100"><img src="${notice.imageUrl}" class="w-full h-auto object-cover max-h-96" loading="lazy" alt="Notice Attachment"></div>`;
                }
                if (notice.linkUrl) {
                    mediaHTML += `<a href="${notice.linkUrl}" target="_blank" class="inline-flex items-center text-sm font-bold theme-text hover:underline mb-4"><i class="fa-solid fa-link mr-2"></i>Attached Link / Resource</a>`;
                }

                const card = document.createElement('div');
                card.className = "notice-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 relative mb-6";

                card.innerHTML = `
            <div class="absolute top-0 left-0 h-full w-1" style="background-color: ${accentColor}"></div>
            <div class="p-5 sm:p-6 pl-6 sm:pl-8">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-gray-50 text-gray-600 border border-gray-200">
                        <i class="fa-solid ${icon} mr-1" style="color: ${accentColor}"></i> ${category}
                    </span>
                    <span class="text-xs text-gray-400 font-medium">${new Date(notice.timestamp).toLocaleDateString()}</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3 leading-snug">${notice.title}</h3>
                <p class="text-gray-600 leading-relaxed whitespace-pre-wrap text-sm mb-4">${notice.content}</p>
                <!-- Media -->
                ${mediaHTML}
                <!-- Interactions -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100 mt-2">
                    <div class="flex space-x-4">
                        <button onclick="handleLike('${schoolId}', '${notice.id}')" class="flex items-center space-x-1 text-gray-500 hover:text-blue-600 transition">
                            <i class="fa-regular fa-thumbs-up"></i> <span class="text-xs font-bold">${notice.likes || 0}</span>
                        </button>
                        <button onclick="handleDislike('${schoolId}', '${notice.id}')" class="flex items-center space-x-1 text-gray-500 hover:text-red-600 transition">
                            <i class="fa-regular fa-thumbs-down"></i> <span class="text-xs font-bold">${notice.dislikes || 0}</span>
                        </button>
                        <div class="flex items-center space-x-1 text-gray-400">
                            <i class="fa-regular fa-eye"></i> <span class="text-xs">${notice.views || 0}</span>
                        </div>
                    </div>
                    <button onclick="toggleComments('${schoolId}', '${notice.id}')" class="text-xs font-bold text-gray-400 hover:text-gray-600 transition">
                        ${commentsCount} Comments <i class="fa-solid fa-chevron-down ml-1"></i>
                    </button>
                </div>
                <!-- Comments Section -->
                <div id="comments-${notice.id}" class="hidden mt-4 pt-4 bg-gray-50 -mx-6 px-6 pb-2 border-t border-gray-100">
                    <div id="comments-list-${notice.id}" class="space-y-3 mb-4">
                         ${notice.comments ? Object.values(notice.comments).map(c => `
                            <div class="text-xs bg-white p-2 rounded border border-gray-200 shadow-sm">
                                <p class="text-gray-700">${c.text}</p>
                                <p class="text-[10px] text-gray-400 mt-1 text-right">${new Date(c.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                            </div>`).join('') : '<p class="text-center text-gray-400 text-xs py-2">No comments yet.</p>'}
                    </div>
                    <form onsubmit="postComment(event, '${schoolId}', '${notice.id}')" class="flex gap-2">
                        <input type="text" name="comment" required placeholder="Anonymous comment..."
                            class="flex-1 text-xs px-3 py-2 border rounded-full focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white">
                            <button type="submit" class="w-8 h-8 rounded-full theme-bg text-white flex items-center justify-center shadow-sm hover:opacity-90">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                    </form>
                </div>
            </div>`;
                list.appendChild(card);
            });
        };

        // --- Interaction Logic ---

        // Helper to track local interactions
        function checkInteraction(type, id) {
            const storage = JSON.parse(localStorage.getItem('gurukul_interactions') || '{"likes":[],"dislikes":[],"views":[],"comments":[]}');
            return storage[type] && storage[type].includes(id);
        }

        function recordInteraction(type, id) {
            const storage = JSON.parse(localStorage.getItem('gurukul_interactions') || '{"likes":[],"dislikes":[],"views":[],"comments":[]}');
            if (!storage[type]) storage[type] = [];
            if (!storage[type].includes(id)) {
                storage[type].push(id);
                localStorage.setItem('gurukul_interactions', JSON.stringify(storage));
            }
        }

        // Use Transaction to handle concurrent likes/dislikes safely
        window.handleLike = (schoolId, noticeId) => {
            if (checkInteraction('likes', noticeId)) return alert('You have already liked this notice.');

            const likeRef = ref(db, `schools/${schoolId}/notices/${noticeId}/likes`);
            runTransaction(likeRef, (currentLikes) => {
                return (currentLikes || 0) + 1;
            }).then(() => {
                recordInteraction('likes', noticeId);
                // Simple UI feedback (optional, as reactive update handles it)
            });
        };

        window.handleDislike = (schoolId, noticeId) => {
            if (checkInteraction('dislikes', noticeId)) return alert('You have already disliked this notice.');

            const dislikeRef = ref(db, `schools/${schoolId}/notices/${noticeId}/dislikes`);
            runTransaction(dislikeRef, (currentDislikes) => {
                return (currentDislikes || 0) + 1;
            }).then(() => {
                recordInteraction('dislikes', noticeId);
            });
        };

        window.toggleComments = (schoolId, noticeId) => {
            const el = document.getElementById(`comments-${noticeId}`);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                // Increment View ONLY when opening details/comments to signify interest
                // AND only if not viewed before
                if (!checkInteraction('views', noticeId)) {
                    const viewRef = ref(db, `schools/${schoolId}/notices/${noticeId}/views`);
                    runTransaction(viewRef, (v) => (v || 0) + 1).then(() => {
                        recordInteraction('views', noticeId);
                    });
                }
            } else {
                el.classList.add('hidden');
            }
        };

        window.postComment = async (e, schoolId, noticeId) => {
            e.preventDefault();
            console.log("Attempting to post comment...", { schoolId, noticeId });

            if (checkInteraction('comments', noticeId)) {
                return alert('You have already commented on this notice.');
            }

            const form = e.target;
            const input = form.querySelector('input');
            const text = input.value.trim();

            if (!text) return;

            // Simple client-side validation for Firebase Keys
            if (!schoolId || !noticeId) {
                console.error("Missing IDs", { schoolId, noticeId });
                return alert("Error: Missing internal data. Please refresh.");
            }

            const btn = form.querySelector('button');
            const originalIcon = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xs"></i>';

            try {
                // Fetch Meta Data (IP/Device) for Safety
                const meta = await getUserMeta();

                const commentRef = ref(db, `schools/${schoolId}/notices/${noticeId}/comments`);
                await push(commentRef, {
                    text: text,
                    timestamp: new Date().toISOString(),
                    meta: meta // Save tracking info
                });
                console.log("Comment posted successfully.");
                recordInteraction('comments', noticeId);
                form.reset();
                // Optional: Show temporary success message
            } catch (err) {
                console.error("Firebase Comment Error:", err);
                // If it's permission denied, it's rules. If it's other, it's network/logic.
                if (err.code === 'PERMISSION_DENIED') {
                    alert("Unable to comment: Permission denied. (Check Database Rules)");
                } else {
                    alert("Failed to post comment: " + err.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalIcon;
            }
        };


        // --- Utils ---
        window.toggleAuthMode = (mode) => {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const tabLogin = document.getElementById('tab-login');
            const tabSignup = document.getElementById('tab-signup');
            const errorBox = document.getElementById('auth-error');

            errorBox.classList.add('hidden');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');

                tabLogin.classList.add('theme-text', 'border-b-2', 'theme-border');
                tabLogin.classList.remove('text-gray-400');

                tabSignup.classList.remove('theme-text', 'border-b-2', 'theme-border');
                tabSignup.classList.add('text-gray-400');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');

                tabSignup.classList.add('theme-text', 'border-b-2', 'theme-border');
                tabSignup.classList.remove('text-gray-400');

                tabLogin.classList.remove('theme-text', 'border-b-2', 'theme-border');
                tabLogin.classList.add('text-gray-400');
            }
        };

        window.copyLink = () => {
            const input = document.getElementById('public-link-input');
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand("copy");
            const btn = input.nextElementSibling;
            const originalText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = originalText, 2000);
        };

        window.goHome = () => window.location.href = window.location.pathname;

        function showError(msg) {
            const box = document.getElementById('auth-error');
            document.getElementById('auth-error-msg').innerText = msg.replace("Firebase:", "").replace("auth/", "");
            box.classList.remove('hidden');
        }

        function setLoading(state) {
            const loader = document.getElementById('loading-view');
            if (state) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            handleRouting();
        });

        // --- PWA Logic : Capture Prompt ---
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            // The logic inside loadPublicSchoolData will use this

            // Also show nav btn if relevant (legacy)
            const installBtn = document.getElementById('install-btn');
            if (installBtn) installBtn.classList.remove('hidden');
        });

        // Register Service Worker
        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }
        // --- Suggestion Box Logic ---

        async function getUserMeta() {
            let ip = "Unknown";
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                ip = data.ip;
            } catch (e) {
                console.warn("Could not fetch IP", e);
            }
            return {
                ip: ip,
                device: navigator.userAgent
            };
        }

        window.submitSuggestion = async (e) => {
            e.preventDefault();
            const text = document.getElementById('suggestion-text').value.trim();
            if (!text) return;

            // Simple Local Limit (1 per day)
            const lastDate = localStorage.getItem('last_suggestion_date');
            const today = new Date().toDateString();
            if (lastDate === today) {
                alert("You can only submit one suggestion per day. Thank you!");
                document.getElementById('suggestion-modal').classList.add('hidden');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const schoolId = urlParams.get('school');
            if (!schoolId) return alert("System Error: No School ID found.");

            try {
                const btn = e.target.querySelector('button');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

                // Fetch Meta Data (IP/Device) for Safety
                const meta = await getUserMeta();

                await push(ref(db, `schools/${schoolId}/suggestions`), {
                    text: text,
                    timestamp: new Date().toISOString(),
                    meta: meta // Save tracking info
                });

                localStorage.setItem('last_suggestion_date', today);
                alert("Thank you! Your suggestion has been sent anonymously.");
                e.target.reset();
                document.getElementById('suggestion-modal').classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("Failed to send suggestion. Please try again.");
            } finally {
                const btn = e.target.querySelector('button');
                btn.disabled = false;
                btn.innerText = 'Send Anonymously';
            }
        };

        window.loadSuggestions = () => {
            const list = document.getElementById('inbox-list');
            list.innerHTML = '<div class="text-center py-4"><div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6 mx-auto"></div></div>';

            onValue(ref(db, `schools/${currentUser.uid}/suggestions`), (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = '';

                if (!data) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-8">No suggestions received yet.</p>';
                    return;
                }

                const suggestions = Object.entries(data).map(([key, val]) => ({ id: key, ...val }));
                suggestions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                suggestions.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-50 p-4 rounded-lg border border-gray-100 relative group';
                    let metaHTML = '';
                    if (s.meta) {
                        metaHTML = `<div class="mt-2 pt-2 border-t border-gray-100">
                            <p class="text-[10px] text-gray-400 font-mono"><i class="fa-solid fa-shield-halved mr-1"></i> IP: ${s.meta.ip} <span class="mx-1"></span> Device: ${s.meta.device}</p>
                        </div>`;
                    }

                    item.innerHTML = `
                        <p class="text-gray-800 text-sm whitespace-pre-wrap mb-2">${s.text}</p>
                        ${metaHTML}
                        <div class="flex justify-between items-center mt-2">
                             <span class="text-[10px] text-gray-400 font-mono">${new Date(s.timestamp).toLocaleString()}</span>
                             <button onclick="deleteSuggestion('${s.id}')" class="text-red-400 hover:text-red-600 text-xs font-bold opacity-0 group-hover:opacity-100 transition">Delete</button>
                        </div>
                     `;
                    list.appendChild(item);
                });
            });
        };

        window.deleteSuggestion = async (id) => {
            if (confirm("Delete this suggestion permanently?")) {
                await remove(ref(db, `schools/${currentUser.uid}/suggestions/${id}`));
            }
        };


        // --- Dynamic PWA Manifest Logic ---
        function updateDynamicManifest(profile) {
            try {
                // 1. Update Basic Meta
                document.title = profile.name || "Gurukul Notices";

                // 2. Update Apple Touch Icon
                const linkApple = document.querySelector("link[rel='apple-touch-icon']");
                if (linkApple && profile.logoUrl) {
                    linkApple.href = profile.logoUrl;
                }

                // 3. Construct Dynamic Manifest
                const dynamicManifest = {
                    "name": profile.name || "Gurukul Notice Platform",
                    "short_name": (profile.name && profile.name.length > 12) ? profile.name.substring(0, 12) + "..." : (profile.name || "Gurukul"),
                    "background_color": "#f8fafc",
                    "theme_color": profile.themeColor || "#1e40af",
                    "display": "standalone",
                    "start_url": window.location.href, // IMPORTANT: Open the specific school URL
                    "icons": [
                        {
                            "src": profile.logoUrl || "https://cdn-icons-png.flaticon.com/512/3413/3413535.png",
                            "sizes": "192x192", // We assume base64 scales/is valid, or browser handles resizing
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        {
                            "src": profile.logoUrl || "https://cdn-icons-png.flaticon.com/512/3413/3413535.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                // 4. Create Blob & Replace Link
                const stringManifest = JSON.stringify(dynamicManifest);
                const blob = new Blob([stringManifest], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(blob);

                const linkManifest = document.querySelector("link[rel='manifest']");
                if (linkManifest) {
                    linkManifest.href = manifestURL;
                } else {
                    const newLink = document.createElement('link');
                    newLink.rel = 'manifest';
                    newLink.href = manifestURL;
                    document.head.appendChild(newLink);
                }

                console.log("PWA Manifest Updated Dynamically for: " + profile.name);

            } catch (error) {
                console.error("Failed to update manifest:", error);
            }
        }
    </script>
</body>

</html>